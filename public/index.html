<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SeaSalt Admin â€” Competitor Intel (Live)</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}body{background:#0B0E11;color:#E8ECF1;font-family:'DM Sans',sans-serif}
  ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#252B38;border-radius:3px}
  .sl{display:flex;align-items:center;gap:10px;padding:10px 16px;border-radius:10px;font-size:.82rem;font-weight:500;color:#8B95A5;cursor:pointer;transition:.15s}
  .sl:hover{background:rgba(255,255,255,.04);color:#E8ECF1}.sl.on{background:rgba(255,77,45,.12);color:#FF4D2D;font-weight:600}
  .cd{background:#141820;border:1px solid #252B38;border-radius:12px;overflow:hidden}
  .ch{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #252B38}
  .ch h3{font-size:.85rem;font-weight:600;display:flex;align-items:center;gap:8px}
  .bg{font-size:.6rem;font-family:'Space Mono',monospace;padding:3px 8px;border-radius:6px}
  .bg-l{background:rgba(34,197,94,.1);color:#22C55E}.bg-c{background:#1A1F2B;color:#8B95A5}
  .tbl{width:100%;border-collapse:collapse}
  .tbl th{text-align:left;padding:10px 14px;font-size:.6rem;color:#8B95A5;text-transform:uppercase;letter-spacing:.08em;font-family:'Space Mono',monospace;border-bottom:1px solid #252B38;font-weight:400}
  .tbl td{padding:13px 14px;border-bottom:1px solid rgba(37,43,56,.4);font-size:.82rem}
  .tbl tr:last-child td{border-bottom:none}.tbl tr.clk{cursor:pointer;transition:.12s}.tbl tr.clk:hover{background:rgba(255,77,45,.04)}
  .btn{padding:9px 18px;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.78rem;cursor:pointer;transition:.2s}
  .bp{background:#FF4D2D;color:#fff}.bp:hover{background:#FF6B4D}.bg2{background:#141820;color:#E8ECF1;border:1px solid #252B38}.bg2:hover{border-color:#FF4D2D}
  .bs{padding:6px 12px;font-size:.7rem;border-radius:6px}
  .ai-box{background:linear-gradient(135deg,rgba(255,77,45,.07),rgba(255,140,66,.03));border:1px solid rgba(255,77,45,.25);border-radius:12px;padding:20px}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}.dot{width:7px;height:7px;border-radius:50%;background:#22C55E;box-shadow:0 0 8px rgba(34,197,94,.5);animation:pulse 2s infinite}
  @keyframes spin{to{transform:rotate(360deg)}}.spinner{width:20px;height:20px;border:2px solid #252B38;border-top-color:#FF4D2D;border-radius:50%;animation:spin .6s linear infinite}
  .pf{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;cursor:pointer;font-size:.8rem;transition:.15s;border:1px solid transparent}
  .pf.on{background:rgba(255,77,45,.12);border-color:rgba(255,77,45,.3);color:#fff}.pf.off{color:#8B95A5}.pf.off:hover{background:rgba(255,255,255,.03)}
  .fade-in{animation:fadeIn .3s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
</style>
</head>
<body>
<div class="flex min-h-screen">

<!-- SIDEBAR -->
<aside class="w-60 border-r border-gray-800 flex flex-col p-4 flex-shrink-0" style="background:#0D1015">
  <div class="flex items-center gap-3 mb-8 px-2">
    <div class="w-9 h-9 rounded-lg flex items-center justify-center text-lg" style="background:linear-gradient(135deg,#FF4D2D,#FF8C42)">ğŸ«™</div>
    <div><div class="font-bold text-sm">SeaSalt Admin</div><div class="text-xs text-gray-600" style="font-family:monospace">Intel v2.0 Â· LIVE</div></div>
  </div>
  <div class="text-xs text-gray-600 uppercase tracking-widest px-2 mb-2" style="font-family:monospace">Main</div>
  <a href="admin-index.html" class="sl">ğŸ“Š Dashboard</a>
  <a href="admin-index.html#analytics" class="sl">ğŸ“ˆ Analytics</a>
  <a href="admin-index.html#orders" class="sl">ğŸ“¦ Orders</a>
  <a href="admin-index.html#products" class="sl">ğŸ·ï¸ Products</a>
  <a href="admin-index.html#users" class="sl">ğŸ‘¥ Users</a>
  <div class="text-xs text-gray-600 uppercase tracking-widest px-2 mb-2 mt-6" style="font-family:monospace">Intelligence</div>
  <div class="sl on" onclick="go('intel')" id="n-intel">ğŸ† Competitor Intel</div>
  <div class="sl" onclick="go('social')" id="n-social">ğŸ“± Social Hub</div>
  <div class="sl" onclick="go('insights')" id="n-insights">ğŸ§  Insights</div>
  <div class="sl" onclick="go('listeners')" id="n-listeners">ğŸ‘¥ Social Listeners</div>
  <div class="flex-1"></div>
  <div class="px-2 py-3 rounded-lg" style="background:rgba(255,77,45,.06);border:1px solid rgba(255,77,45,.15)">
    <div class="flex items-center gap-2 mb-1"><div class="dot"></div><span class="text-xs text-gray-500" style="font-family:monospace">Live Â· Supabase Connected</span></div>
    <div class="text-xs text-gray-600" style="font-family:monospace">Last sync: <span id="sb-sync">â€”</span></div>
  </div>
</aside>

<!-- MAIN -->
<main class="flex-1 overflow-y-auto" style="max-height:100vh">
  <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800 sticky top-0 z-40" style="background:#0B0E11">
    <div><h1 class="text-lg font-bold" id="ptitle">ğŸ† Competitor Intelligence</h1><p class="text-xs text-gray-500" style="font-family:monospace" id="psub">Live Data Â· Supabase + Google Places API</p></div>
    <div class="flex items-center gap-3">
      <div id="sync-spinner" class="hidden"><div class="spinner"></div></div>
      <button class="btn bg2 bs" onclick="syncNow()">ğŸ”„ Sync All</button>
        <button class="btn bg2 bs" onclick="scanAds()">ğŸ“¢ Scan Ads</button>
        <button class="btn bg2 bs" onclick="scanYT()">â–¶ï¸ Scan YouTube</button>
        <button class="btn bp bs" onclick="scanSocial()">ğŸ‘¥ Scan Commenters</button>
      <button class="btn bp bs" onclick="exportCSV()">â†“ Export</button>
    </div>
  </div>
  <div class="p-6 fade-in" id="content"></div>
</main>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL='https://yosjbsncvghpscsrvxds.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvc2pic25jdmdocHNjc3J2eGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjc3NTgsImV4cCI6MjA4NTgwMzc1OH0.PNEbeofoyT7KdkzepRfqg-zqyBiGAat5ElCMiyQ4UAs';
const SEASALT={avakaya:349,chicken:499,gongura:299,lemon:249,garlic:279};
const PRODUCTS=["Avakaya Mango Pickle","Gongura Red Chilli Pickle","Chicken Pickle with Bone","Boneless Chicken Pickle","Mutton Pickle","Prawn Pickle","Garlic Pachadi","Tomato Thokku","Lemon Spice Pickle","Mixed Vegetable Pickle","Summer Combo Pack","Family Pack"];
const PLATFORMS=[{id:"ig_post",l:"Instagram Post",i:"ğŸ“¸"},{id:"ig_reel",l:"Reel Script",i:"ğŸ¬"},{id:"fb_post",l:"Facebook Post",i:"ğŸ“˜"},{id:"g_post",l:"Google Business",i:"ğŸ“"},{id:"wa_msg",l:"WhatsApp Broadcast",i:"ğŸ’¬"},{id:"yt_short",l:"YouTube Short",i:"â–¶ï¸"}];

let page='intel',drill=null,comps=[],revs=[],ads=[],engUsers=[],userProfiles=[],compSocials=[],compContent=[],sPlat='ig_post',sProd=PRODUCTS[0];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sbGet(table,params=''){
  const r=await fetch(`${SB_URL}/rest/v1/${table}?${params}`,{headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`}});
  return r.ok?r.json():[];
}

async function loadData(){
  try{
    comps=await sbGet('competitors','select=*&order=google_reviews_count.desc');
    revs=await sbGet('competitor_reviews','select=*&order=publish_time.desc&limit=50');
    ads=await sbGet('competitor_ads','select=*&order=detected_at.desc&limit=50');
    // Update ad counts on competitors
    comps.forEach(c=>{
      const compAds=ads.filter(a=>a.competitor_name===c.name&&a.ad_status==='active');
      c.active_ads_count=compAds.length;
    });
    if(comps.length>0){
      const last=comps[0].last_synced;
      document.getElementById('sb-sync').textContent=last?timeAgo(new Date(last)):'never';
    }
  }catch(e){console.error('Load error:',e);comps=[];revs=[];ads=[];}
  render();
}

async function sbInsert(table,data){
  try{
    const r=await fetch(SB_URL+'/rest/v1/'+table,{method:'POST',headers:{'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Prefer':'return=representation'},body:JSON.stringify(data)});
    return r.ok;
  }catch(e){return false;}
}

async function logAd(compName){
  const text=document.getElementById('ad-text-input').value;
  const platform=document.getElementById('ad-platform-input').value;
  const region=document.getElementById('ad-region-input').value;
  if(!text){alert('Enter ad text');return;}
  const ok=await sbInsert('competitor_ads',{
    competitor_name:compName,
    ad_text:text,
    platform:platform,
    region:region,
    ad_status:'active',
    started_date:new Date().toISOString().slice(0,10),
    detected_at:new Date().toISOString()
  });
  if(ok){alert('Ad logged!');document.getElementById('ad-text-input').value='';await loadData();}
  else alert('Failed to save');
}

async function removeAd(adId){
  try{
    await fetch(SB_URL+'/rest/v1/competitor_ads?id=eq.'+adId,{method:'PATCH',headers:{'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY},body:JSON.stringify({ad_status:'ended'})});
    await loadData();
  }catch(e){}
}

function metaAdUrl(name){return 'https://www.facebook.com/ads/library/?active_status=active&ad_type=all&country=IN&q='+encodeURIComponent(name);}

function timeAgo(d){const s=Math.floor((Date.now()-d)/1000);if(s<60)return s+'s ago';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago';}

async function syncNow(){
  const sp=document.getElementById('sync-spinner');
  sp.classList.remove('hidden');
  try{
    const r=await fetch('/.netlify/functions/intel-sync?action=sync');
    const d=await r.json();
    if(d.success){alert('âœ… Synced '+d.count+' competitors!\nReviews: '+d.review_count+'\nAds detected: '+(d.ad_count||0));await loadData();}
    else alert('Sync failed: '+JSON.stringify(d));
  }catch(e){alert('Sync error: '+e.message);}
  sp.classList.add('hidden');
}

async function scanYT(){
  const sp=document.getElementById('sync-spinner');sp.classList.remove('hidden');
  try{
    const r=await fetch('/.netlify/functions/intel-sync?action=scan-youtube');
    const d=await r.json();
    if(d.success){
      const det=d.details||[];
      const total=det.reduce((s,x)=>s+(x.videos_found||0),0);
      alert('â–¶ï¸ YouTube scan complete!\nTotal videos found: '+total+'\n\n'+det.filter(x=>x.videos_found>0).map(x=>x.name+': '+x.videos_found+' videos').join('\n'));
      await loadData();
    }else alert('Failed: '+JSON.stringify(d));
  }catch(e){alert('Error: '+e.message);}
  sp.classList.add('hidden');
}

async function scanSocial(){
  const sp=document.getElementById('sync-spinner');sp.classList.remove('hidden');
  try{
    const r=await fetch('/.netlify/functions/social-listen?action=scan');
    const d=await r.json();
    if(d.success){
      alert('ğŸ•µï¸ Deep scan complete!\nVideos: '+d.total_videos+'\nUsers: '+d.total_users+'\nDeep profiled: '+d.total_profiled+'\n\n'+d.details.filter(x=>x.users>0).map(x=>x.name+': '+x.users+' users ('+x.withSocials+' with socials)').join('\n'));
      await loadSocialData();
      if(page==='listeners') render();
    }else alert('Failed: '+JSON.stringify(d));
  }catch(e){alert('Error: '+e.message);}
  sp.classList.add('hidden');
}

async function loadSocialData(){
  try{
    const r=await fetch('/.netlify/functions/social-listen?action=get-users');
    const d=await r.json();
    engUsers=d.users||[];userProfiles=d.profiles||[];compSocials=d.socials||[];compContent=d.content||[];
  }catch(e){engUsers=[];userProfiles=[];compSocials=[];compContent=[];}
}

function formatSubs(s){if(!s||s==='0')return'â€”';const n=parseInt(s);if(n>=1000000)return(n/1000000).toFixed(1)+'M';if(n>=1000)return(n/1000).toFixed(1)+'K';return String(n);}

// Manual user logging for IG/FB/LinkedIn
async function logUser(){
  const u=document.getElementById('lu-username').value.trim();
  const p=document.getElementById('lu-platform').value;
  const c=document.getElementById('lu-competitor').value;
  const t=document.getElementById('lu-type').value;
  const txt=document.getElementById('lu-comment').value.trim();
  if(!u){alert('Enter username');return;}
  let url='';
  if(p==='Instagram')url='https://instagram.com/'+u.replace('@','');
  else if(p==='Facebook')url='https://facebook.com/'+u.replace('@','');
  else if(p==='LinkedIn')url='https://linkedin.com/in/'+u.replace('@','');
  else if(p==='Twitter/X')url='https://x.com/'+u.replace('@','');
  else url=u;
  const ok=await sbInsert('engaged_users',{
    username:u.replace('@',''),display_name:u.replace('@',''),
    profile_url:url,platform:p,competitor_name:c,
    engagement_type:t,content_text:txt||'Manually logged',
    content_url:'',video_title:'Manual entry',
    detected_at:new Date().toISOString()
  });
  if(ok){
    document.getElementById('lu-username').value='';
    document.getElementById('lu-comment').value='';
    await loadSocialData();render();
    alert('âœ… User logged: @'+u.replace('@',''));
  }else alert('Failed to save');
}

// Competitor social quick-links for manual browsing
const COMP_SOCIALS={
  'Vellanki Foods':{ig:'vellankifoods',fb:'VellankiFoods'},
  'Priya Pickles':{ig:'priyafoodsofficial',fb:'PriyaFoodsOfficial'},
  'Nirupama Pickles':{ig:'nirupamapickles',fb:'nirupamapickles'},
  'Tulasi Pickles':{fb:'tulasipickleshyderabad'},
  'Aavarampoo Pickles':{ig:'aavarampoo_pickles'},
  'Sitara Pickles':{ig:'sitarafoods'},
  'Ruchulu Pickles':{ig:'ruchulupickles'},
  'Ammas Homemade Pickles':{},
  'Andhra Pickles':{},
  'Hyderabad Pickles':{}
};
function igUrl(h){return h?'https://instagram.com/'+h:null;}
function fbUrl(h){return h?'https://facebook.com/'+h:null;}

async function scanAds(){
  const sp=document.getElementById('sync-spinner');
  sp.classList.remove('hidden');
  try{
    const r=await fetch('/.netlify/functions/intel-sync?action=scan-ads');
    const d=await r.json();
    if(d.success){
      const details=d.details||[];
      const found=details.filter(x=>x.ads_detected>0);
      alert('ğŸ“¢ Ad scan complete!\nTotal ads detected: '+d.total_ads+'\nCompetitors with ads: '+found.length+'/'+details.length+'\n\n'+(found.length>0?found.map(x=>x.name+': '+x.ads_detected+' ads').join('\n'):'No active ads detected. Meta may be blocking server requests â€” use manual logging for now.'));
      await loadData();
    } else alert('Scan failed: '+JSON.stringify(d));
  }catch(e){alert('Scan error: '+e.message);}
  sp.classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI ACTIONS GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function aiActions(c){
  const a=[];
  if(c.active_ads_count>2)a.push({p:'ğŸ”´',t:`${c.name} is running ${c.active_ads_count} ads. Launch a counter-campaign within 48h.`});
  if(c.google_rating>=4.5)a.push({p:'ğŸŸ¡',t:`${c.name} has ${c.google_rating}â˜… rating. Collect 20+ reviews this month to match.`});
  if(c.google_reviews_count>2000)a.push({p:'ğŸŸ ',t:`${c.name} has ${c.google_reviews_count.toLocaleString()} reviews. Offer â‚¹50 wallet credit per review. Target 50 in 30 days.`});
  if(c.active_ads_count===0)a.push({p:'ğŸŸ¢',t:`${c.name} has ZERO ads. Their customers are undefended. Run targeted ads NOW.`});
  if(c.status==='inactive')a.push({p:'ğŸŸ¢',t:`${c.name} appears inactive. Bid on their brand keywords in Google Ads.`});
  if(c.google_rating>0&&c.google_rating<4.0)a.push({p:'ğŸŸ¢',t:`${c.name} has low ${c.google_rating}â˜… rating. Highlight your superior quality in ads.`});
  if(a.length===0)a.push({p:'ğŸ”µ',t:`Monitor ${c.name}. No immediate action needed.`});
  return a;
}

const stars=r=>'â˜…'.repeat(Math.floor(r||0))+(((r||0)%1>=.5)?'Â½':'')+'â˜†'.repeat(5-Math.floor(r||0)-(((r||0)%1>=.5)?1:0));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENT GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genContent(p,prod){
  const m={
    ig_post:`ğŸ«™ Craving authentic Andhra ${prod}?\n\nHandmade with cold-pressed groundnut oil, zero preservatives, and recipes passed down through generations.\n\nEvery jar is made fresh in small batches â€” not in a factory.\n\nğŸ”¥ Order now: seasaltpickles.com\nğŸ“± WhatsApp: +91 9963971447\n\n#SeaSaltPickles #AndhrPickles #${prod.replace(/\s/g,'')} #HomemadePickles #Hyderabad #TeluguFood #NoPreservatives #ColdPressedOil`,
    ig_reel:`ğŸ¬ REEL SCRIPT â€” ${prod}\n\n[0-2s] HOOK: Close-up jar opening\nText: "This isn't factory pickle..."\n\n[2-5s] Fresh ingredients being washed\nText: "Fresh ingredients. No shortcuts."\n\n[5-8s] Hands mixing in traditional jar\nText: "Handmade with cold-pressed oil"\n\n[8-12s] Beauty shot with rice\nText: "Authentic ${prod}"\n\n[12-15s] CTA\nText: "seasaltpickles.com | Link in bio"\n\nğŸµ Trending Telugu folk sound`,
    fb_post:`ğŸ«™ Fresh batch alert!\n\nOur ${prod} is ready â€” made this morning with:\nâœ… Cold-pressed groundnut oil\nâœ… Hand-ground spices\nâœ… Zero preservatives\nâœ… Traditional family recipe\n\nğŸ›’ seasaltpickles.com\nğŸ“± wa.me/919963971447\nğŸšš Free delivery Hyderabad | Ships all India`,
    g_post:`ğŸ«™ Fresh ${prod} Now Available!\n\nMade with cold-pressed oil, zero preservatives. Authentic Andhra recipe, handmade in Hyderabad.\n\nOrder: seasaltpickles.com\nWhatsApp: +91 9963971447\nğŸšš Same-day delivery Hyderabad!`,
    wa_msg:`ğŸ«™ *SeaSalt Pickles â€” Fresh Batch!*\n\nHi! Our *${prod}* is freshly made!\n\nâœ¨ Cold-pressed groundnut oil\nâœ¨ No preservatives\nâœ¨ Traditional Andhra recipe\n\nğŸ’° From â‚¹249\nğŸšš Free delivery Hyderabad\n\nğŸ‘‰ seasaltpickles.com\nğŸ‘‰ Reply "ORDER"!`,
    yt_short:`ğŸ¬ YOUTUBE SHORT â€” ${prod}\n\n[0-1s] Mortar grinding sound\nText: "They use machines..."\n\n[1-3s] Your hands grinding spices\nText: "We use tradition."\n\n[3-6s] Time-lapse of making\nText: "Cold-pressed oil. Zero preservatives."\n\n[6-9s] Factory vs kitchen split\nText: "Factory vs Handmade"\n\n[9-12s] Tasting reaction with rice\n\n[12-15s] Logo + CTA\n"seasaltpickles.com"\n\n#shorts #pickle #andhra #homemade`
  };
  return m[p]||'Select platform.';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(pg){page=pg;drill=null;document.querySelectorAll('.sl').forEach(e=>e.classList.remove('on'));
  document.getElementById('n-'+pg)?.classList.add('on');render();}

function drillTo(name){drill=comps.find(c=>c.name===name);render();}
function drillBack(){drill=null;render();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  const el=document.getElementById('content');
  const t=document.getElementById('ptitle');
  const s=document.getElementById('psub');
  el.className='p-6 fade-in';

  if(page==='intel'&&!drill){
    t.textContent='ğŸ† Competitor Intelligence';
    s.textContent=`${comps.length} competitors tracked Â· Live from Supabase + Google Places`;
    
    if(comps.length===0){
      el.innerHTML=`<div class="text-center py-20">
        <div class="text-5xl mb-4">ğŸ“¡</div>
        <h2 class="text-xl font-bold mb-2">No Data Yet</h2>
        <p class="text-gray-500 mb-6">Click "ğŸ”„ Sync Live Data" to fetch competitor data from Google Places API and store in Supabase.</p>
        <button onclick="syncNow()" class="btn bp">ğŸ”„ Run First Sync</button>
        <p class="text-xs text-gray-600 mt-4" style="font-family:monospace">Make sure you've:<br>1. Run the SQL in Supabase (supabase-intel-tables.sql)<br>2. Deployed intel-sync.js to netlify/functions/</p>
      </div>`;
      return;
    }

    const totalReviews=comps.reduce((s,c)=>s+(c.google_reviews_count||0),0);
    const totalAds=comps.reduce((s,c)=>s+(c.active_ads_count||0),0);
    const avgRating=(comps.reduce((s,c)=>s+(c.google_rating||0),0)/comps.length).toFixed(1);

    el.innerHTML=`
    <div class="grid grid-cols-4 gap-4 mb-5">
      <div class="cd p-5"><div class="text-xs text-gray-500 uppercase tracking-wider mb-2" style="font-family:monospace">Competitors</div><div class="text-3xl font-bold">${comps.length}</div><div class="text-xs text-green-400 mt-1">â— Live tracking</div></div>
      <div class="cd p-5"><div class="text-xs text-gray-500 uppercase tracking-wider mb-2" style="font-family:monospace">Total Reviews</div><div class="text-3xl font-bold">${totalReviews.toLocaleString()}</div><div class="text-xs text-gray-500 mt-1">Across all competitors</div></div>
      <div class="cd p-5"><div class="text-xs text-gray-500 uppercase tracking-wider mb-2" style="font-family:monospace">Active Ads</div><div class="text-3xl font-bold">${totalAds}</div><div class="text-xs text-gray-500 mt-1">Detected via Meta</div></div>
      <div class="cd p-5"><div class="text-xs text-gray-500 uppercase tracking-wider mb-2" style="font-family:monospace">Avg Rating</div><div class="text-3xl font-bold">${avgRating}â˜…</div><div class="text-xs text-gray-500 mt-1">Market average</div></div>
    </div>

    <div class="cd">
      <div class="ch"><h3>ğŸ† Live Competitor Data</h3><span class="bg bg-l">FROM GOOGLE PLACES API</span></div>
      <div style="overflow-x:auto"><table class="tbl"><thead><tr><th>#</th><th>Brand</th><th>Google Rating</th><th>Reviews</th><th>Active Ads</th><th>Status</th><th>Last Synced</th></tr></thead><tbody>
      ${comps.map((c,i)=>`<tr class="clk" onclick="drillTo('${c.name.replace(/'/g,"\\'")}')">
        <td class="text-gray-600" style="font-family:monospace">${i+1}</td>
        <td><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold text-white" style="background:${c.color||'#666'}">${c.code||'??'}</div><div><div class="font-semibold">${c.name}</div><div class="text-xs text-gray-600" style="font-family:monospace">${c.url||''}</div></div></div></td>
        <td><span class="text-yellow-400 text-xs">${stars(c.google_rating)}</span> <span class="font-semibold" style="font-family:monospace">${c.google_rating||'â€”'}</span></td>
        <td class="text-gray-400">${(c.google_reviews_count||0).toLocaleString()}</td>
        <td>${c.active_ads_count?`<span class="bg bg-l">${c.active_ads_count} Active</span>`:'<span class="text-gray-600">0</span>'}</td>
        <td><span class="bg ${c.status==='active'?'bg-l':'bg-c'}">${c.status||'unknown'}</span></td>
        <td class="text-xs text-gray-600" style="font-family:monospace">${c.last_synced?timeAgo(new Date(c.last_synced)):'never'}</td>
      </tr>`).join('')}
      </tbody></table></div>
    </div>

    ${ads.filter(a=>a.ad_status==='active').length?`<div class="cd mt-5"><div class="ch"><h3>ğŸ“¢ Active Competitor Ads</h3><span class="bg bg-l">TRACKED</span></div>
      <div class="p-5 space-y-3">${ads.filter(a=>a.ad_status==='active').slice(0,6).map(a=>'<div class="pb-3 border-b border-gray-800/40 flex gap-3"><div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg flex-shrink-0" style="background:#1A1F2B">ğŸ“¢</div><div class="flex-1"><div class="text-xs font-semibold" style="color:#FF4D2D">'+a.competitor_name+'</div><div class="text-sm mb-1">'+a.ad_text+'</div><div class="text-xs text-gray-500" style="font-family:monospace">'+(a.platform==='YouTube'?'â–¶ï¸ ':a.platform==='Facebook/Instagram'?'ğŸ“˜ ':'ğŸ“¢ ')+a.platform+' Â· '+(a.started_date||'')+' Â· '+(a.region||'')+'</div></div></div>').join('')}</div></div>`:''}

    ${revs.length?`<div class="cd mt-5"><div class="ch"><h3>â­ Latest Competitor Reviews</h3><span class="bg bg-l">LIVE FROM GOOGLE</span></div>
      <div class="p-5 space-y-3">${revs.slice(0,8).map(r=>`<div class="pb-3 border-b border-gray-800/40 last:border-0">
        <div class="flex justify-between items-center mb-1"><span class="text-xs font-semibold" style="color:#3B82F6">${r.competitor_name}</span><span class="text-yellow-400 text-xs">${stars(r.rating)}</span></div>
        <div class="text-sm text-gray-400 italic">"${(r.text||'').substring(0,150)}${(r.text||'').length>150?'...':''}"</div>
        <div class="text-xs text-gray-600 mt-1" style="font-family:monospace">${r.author_name} Â· ${r.relative_time||''}</div>
      </div>`).join('')}</div></div>`:''}`;
  }

  else if(page==='intel'&&drill){
    const c=drill;
    t.textContent=`ğŸ” ${c.name}`;
    s.textContent=`${c.url||''} Â· Live Competitor Profile`;
    const cRevs=revs.filter(r=>r.competitor_name===c.name);
    const actions=aiActions(c);

    el.innerHTML=`
    <div class="text-sm text-gray-500 cursor-pointer hover:text-orange-400 mb-4 flex items-center gap-1" onclick="drillBack()">â† Back to all</div>
    <div class="flex items-center gap-4 mb-6">
      <div class="w-14 h-14 rounded-xl flex items-center justify-center text-xl font-bold text-white" style="background:${c.color}">${c.code}</div>
      <div class="flex-1">
        <h2 class="text-2xl font-bold">${c.name}</h2>
        <div class="text-sm text-gray-500">${c.google_address||c.url||''}</div>
        ${c.google_maps_url?`<a href="${c.google_maps_url}" target="_blank" class="text-xs text-blue-400 hover:underline">Open in Google Maps â†’</a>`:''}
      </div>
      <div class="text-right">
        <div class="text-yellow-400 text-lg">${stars(c.google_rating)} <span class="text-2xl font-bold text-white">${c.google_rating||'â€”'}</span></div>
        <div class="text-sm text-gray-500">${(c.google_reviews_count||0).toLocaleString()} Google reviews</div>
        <div class="text-xs text-gray-600 mt-1">Status: <span class="${c.business_status==='OPERATIONAL'?'text-green-400':'text-orange-400'}">${c.business_status||'UNKNOWN'}</span></div>
      </div>
    </div>

    <div class="ai-box mb-6">
      <h3 class="font-semibold text-sm mb-3">ğŸ§  AI Recommended Actions vs ${c.name}</h3>
      ${actions.map(a=>`<div class="flex gap-3 text-sm mb-2"><span>${a.p}</span><span class="text-gray-300">${a.t}</span></div>`).join('')}
    </div>

    <div class="grid grid-cols-2 gap-4 mb-5">
      <div class="cd p-5">
        <div class="font-semibold text-sm mb-3">ğŸ“Š Key Metrics</div>
        <div class="space-y-3">
          <div class="flex justify-between border-b border-gray-800/40 pb-2"><span class="text-gray-400 text-sm">Google Rating</span><span class="font-semibold">${c.google_rating||'â€”'}â˜…</span></div>
          <div class="flex justify-between border-b border-gray-800/40 pb-2"><span class="text-gray-400 text-sm">Total Reviews</span><span class="font-semibold">${(c.google_reviews_count||0).toLocaleString()}</span></div>
          <div class="flex justify-between border-b border-gray-800/40 pb-2"><span class="text-gray-400 text-sm">Active Ads</span><span class="font-semibold">${c.active_ads_count||0}</span></div>
          <div class="flex justify-between border-b border-gray-800/40 pb-2"><span class="text-gray-400 text-sm">Business Status</span><span class="font-semibold">${c.business_status||'UNKNOWN'}</span></div>
          <div class="flex justify-between border-b border-gray-800/40 pb-2"><span class="text-gray-400 text-sm">Website</span><span class="font-semibold text-blue-400">${c.website_url||c.url||'â€”'}</span></div>
          <div class="mt-3"><a href="${metaAdUrl(c.name)}" target="_blank" class="btn bp bs w-full text-center block" style="text-decoration:none">ğŸ” Check Meta Ad Library â†’</a></div>
        </div>
      </div>
      <div class="cd p-5">
        <div class="font-semibold text-sm mb-3">â­ Reviews from Google (${cRevs.length})</div>
        ${cRevs.length===0?'<div class="text-sm text-gray-600">No reviews synced yet. Click "Sync Live Data" to fetch.</div>':
          cRevs.slice(0,5).map(r=>`<div class="mb-3 pb-3 border-b border-gray-800/40 last:border-0">
            <div class="flex justify-between mb-1"><span class="text-yellow-400 text-xs">${stars(r.rating)}</span><span class="text-xs text-gray-600">${r.relative_time||''}</span></div>
            <div class="text-sm text-gray-400 italic">"${(r.text||'').substring(0,200)}"</div>
            <div class="text-xs text-gray-600 mt-1" style="font-family:monospace">${r.author_name||'Anon'}</div>
          </div>`).join('')}
      </div>
    </div>

    <!-- Ad Campaigns Section -->
    <div class="grid grid-cols-2 gap-4 mt-5">
      <div class="cd">
        <div class="ch"><h3>ğŸ“¢ Tracked Ad Campaigns</h3><a href="${metaAdUrl(c.name)}" target="_blank" class="bg bg-l" style="text-decoration:none;cursor:pointer">Check Meta Ad Library â†’</a></div>
        <div class="p-5">
          ${(()=>{const compAds=ads.filter(a=>a.competitor_name===c.name);return compAds.length===0?'<div class="text-sm text-gray-600">No ads tracked yet. Check Meta Ad Library or log ads manually below.</div>':compAds.map(a=>'<div class="pb-3 mb-3 border-b border-gray-800/40"><div class="text-sm mb-1">'+a.ad_text+'</div><div class="flex justify-between items-center"><div class="text-xs text-gray-500" style="font-family:monospace">'+(a.platform==='YouTube'?'â–¶ï¸ ':a.platform==='Facebook/Instagram'?'ğŸ“˜ ':'ğŸ“¢ ')+a.platform+' Â· '+(a.started_date||'')+' Â· '+(a.region||'India')+'</div>'+(a.ad_status==='active'?'<button onclick="removeAd('+a.id+')" class="text-xs text-gray-600 hover:text-orange-400 cursor-pointer" style="background:none;border:none">Mark ended</button>':'<span class="text-xs text-gray-600">Ended</span>')+'</div></div>').join('');})()}
        </div>
      </div>
      <div class="cd">
        <div class="ch"><h3>â• Log New Ad</h3><span class="bg bg-c">MANUAL ENTRY</span></div>
        <div class="p-5">
          <div class="mb-3"><label class="text-xs text-gray-500 block mb-1">Ad Text / Description</label><textarea id="ad-text-input" rows="3" class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm focus:outline-none focus:border-orange-500" placeholder="Paste the ad copy or describe the campaign..."></textarea></div>
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div><label class="text-xs text-gray-500 block mb-1">Platform</label><select id="ad-platform-input" class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm"><option>Facebook</option><option>Instagram</option><option>FB + IG</option><option>IG Reels</option><option>YouTube</option><option>Google Ads</option></select></div>
            <div><label class="text-xs text-gray-500 block mb-1">Region</label><select id="ad-region-input" class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm"><option>Hyderabad</option><option>Telangana</option><option>AP + TS</option><option>South India</option><option>Pan India</option></select></div>
          </div>
          <button onclick="logAd('${c.name.replace(/'/g,"\\'")}')" class="btn bp w-full">ğŸ“¢ Log This Ad</button>
        </div>
      </div>
    </div>`;
  }

  else if(page==='social'){
    t.textContent='ğŸ“± Social Content Generator';
    s.textContent='Auto-generate posts for all platforms';
    el.innerHTML=`
    <div class="grid grid-cols-12 gap-5">
      <div class="col-span-4 space-y-4">
        <div class="cd p-5"><div class="font-semibold text-sm mb-3">Platform</div>
          ${PLATFORMS.map(p=>`<div class="pf ${sPlat===p.id?'on':'off'}" onclick="sPlat='${p.id}';render()">${p.i} ${p.l}</div>`).join('')}
        </div>
        <div class="cd p-5"><div class="font-semibold text-sm mb-3">Product</div>
          <select onchange="sProd=this.value" class="w-full px-3 py-2.5 rounded-lg bg-gray-900 border border-gray-700 text-sm focus:outline-none focus:border-orange-500">
            ${PRODUCTS.map(p=>`<option value="${p}" ${sProd===p?'selected':''}>${p}</option>`).join('')}
          </select>
        </div>
        <button onclick="document.getElementById('gen-out').textContent=genContent(sPlat,sProd)" class="btn bp w-full py-3">âš¡ Generate</button>
      </div>
      <div class="col-span-8"><div class="cd h-full">
        <div class="ch"><h3>Generated Content</h3><button onclick="navigator.clipboard.writeText(document.getElementById('gen-out').textContent);this.textContent='âœ“ Copied!';setTimeout(()=>this.textContent='ğŸ“‹ Copy',2000)" class="btn bg2 bs">ğŸ“‹ Copy</button></div>
        <pre id="gen-out" class="p-5 text-sm leading-relaxed text-gray-300 whitespace-pre-wrap" style="font-family:'DM Sans',sans-serif;min-height:300px">${genContent(sPlat,sProd)}</pre>
      </div></div>
    </div>
    <div class="cd mt-5"><div class="ch"><h3>ğŸ”— Connected Platforms</h3></div>
      <div class="grid grid-cols-6 gap-3 p-5">
        ${[{n:'Instagram',i:'ğŸ“¸'},{n:'Facebook',i:'ğŸ“˜'},{n:'Google Biz',i:'ğŸ“'},{n:'YouTube',i:'â–¶ï¸'},{n:'WhatsApp',i:'ğŸ’¬',c:1},{n:'Pinterest',i:'ğŸ“Œ'}].map(p=>`
        <div class="border border-gray-800 rounded-lg p-4 text-center hover:border-gray-600 cursor-pointer">
          <div class="text-2xl mb-2">${p.i}</div><div class="text-xs font-semibold mb-1">${p.n}</div>
          <div class="text-xs px-2 py-0.5 rounded inline-block ${p.c?'bg-green-400/10 text-green-400':'bg-gray-800 text-gray-500'}">${p.c?'âœ“ Connected':'Connect â†’'}</div>
        </div>`).join('')}
      </div>
    </div>`;
  }

  else if(page==='listeners'){
    t.textContent='ğŸ•µï¸ Social Spy â€” Deep User Profiles';
    s.textContent='Auto-extracted from YouTube commenters on competitor videos';

    if(engUsers.length===0){
      el.innerHTML='<div class="text-center py-20"><div class="text-5xl mb-4">ğŸ•µï¸</div><h2 class="text-xl font-bold mb-2">No Profiles Yet</h2><p class="text-gray-500 mb-6">Click "ğŸ‘¥ Scan Commenters" to find people engaging with competitor content.<br>The system deep-profiles each user, extracting their Instagram, Facebook, Email from YouTube channels.</p><button onclick="scanSocial()" class="btn bp">ğŸ•µï¸ Run Deep Scan</button><p class="text-xs text-gray-600 mt-4" style="font-family:monospace">Deploy social-listen.mjs to netlify/functions/<br>Run supabase-social-tables.sql in Supabase SQL Editor</p></div>';
      return;
    }

    // Build profile map
    const profileMap={};
    (userProfiles||[]).forEach(p=>{profileMap[p.channel_id]=p;});

    // Count stats
    const uniqueU=[...new Set(engUsers.map(u=>u.username))].length;
    const withIG=(userProfiles||[]).filter(p=>p.instagram_url).length;
    const withEmail=(userProfiles||[]).filter(p=>p.email).length;
    const withFB=(userProfiles||[]).filter(p=>p.facebook_url).length;
    const withWeb=(userProfiles||[]).filter(p=>p.website_url).length;
    const withAnySocial=(userProfiles||[]).filter(p=>p.instagram_url||p.facebook_url||p.twitter_url||p.email||p.website_url||p.whatsapp).length;

    el.innerHTML=\`
    <div class="grid grid-cols-5 gap-3 mb-5">
      <div class="cd p-4"><div class="text-xs text-gray-500 uppercase mb-1" style="font-family:monospace">Users Found</div><div class="text-2xl font-bold">\${uniqueU}</div><div class="text-xs text-green-400">Unique profiles</div></div>
      <div class="cd p-4"><div class="text-xs text-gray-500 uppercase mb-1" style="font-family:monospace">With Instagram</div><div class="text-2xl font-bold" style="color:#E1306C">\${withIG}</div><div class="text-xs text-gray-500">ğŸ“¸ Extracted</div></div>
      <div class="cd p-4"><div class="text-xs text-gray-500 uppercase mb-1" style="font-family:monospace">With Email</div><div class="text-2xl font-bold" style="color:#4FC3F7">\${withEmail}</div><div class="text-xs text-gray-500">ğŸ“§ Contact ready</div></div>
      <div class="cd p-4"><div class="text-xs text-gray-500 uppercase mb-1" style="font-family:monospace">With Facebook</div><div class="text-2xl font-bold" style="color:#1877F2">\${withFB}</div><div class="text-xs text-gray-500">ğŸ“˜ Extracted</div></div>
      <div class="cd p-4"><div class="text-xs text-gray-500 uppercase mb-1" style="font-family:monospace">Has Any Social</div><div class="text-2xl font-bold" style="color:#FF4D2D">\${withAnySocial}</div><div class="text-xs text-gray-500">ğŸ”— Cross-platform</div></div>
    </div>

    \${(userProfiles||[]).filter(p=>p.instagram_url||p.facebook_url||p.email||p.website_url||p.twitter_url||p.whatsapp).length?\`
    <div class="cd mb-5">
      <div class="ch"><h3>ğŸ¯ High-Value Leads â€” Users with Social Links</h3><span class="bg" style="background:rgba(255,77,45,.15);color:#FF4D2D">ACTIONABLE</span></div>
      <div style="overflow-x:auto"><table class="tbl"><thead><tr><th>User</th><th>Subs</th><th>Country</th><th>ğŸ“¸ IG</th><th>ğŸ“˜ FB</th><th>ğŸ¦ X</th><th>ğŸ“§ Email</th><th>ğŸŒ Web</th><th>ğŸ“± WA</th><th>Score</th></tr></thead><tbody>
      \${(userProfiles||[]).filter(p=>p.instagram_url||p.facebook_url||p.email||p.website_url||p.twitter_url||p.whatsapp).sort((a,b)=>(b.influence_score||0)-(a.influence_score||0)).map(p=>\`<tr>
        <td><div class="flex items-center gap-2">\${p.thumbnail?\`<img src="\${p.thumbnail}" style="width:28px;height:28px;border-radius:50%">\`:''}
          <div><div class="font-semibold text-sm">\${p.username||'â€”'}</div>
          <a href="\${p.channel_url||''}" target="_blank" class="text-xs text-blue-400 hover:underline">YT Channel â†’</a></div></div></td>
        <td class="text-xs" style="font-family:monospace">\${formatSubs(p.subscribers)}</td>
        <td class="text-xs">\${p.country||'â€”'}</td>
        <td>\${p.instagram_url?\`<a href="\${p.instagram_url}" target="_blank" class="text-pink-400 text-xs hover:underline">Open</a>\`:''}</td>
        <td>\${p.facebook_url?\`<a href="\${p.facebook_url}" target="_blank" class="text-blue-400 text-xs hover:underline">Open</a>\`:''}</td>
        <td>\${p.twitter_url?\`<a href="\${p.twitter_url}" target="_blank" class="text-sky-400 text-xs hover:underline">Open</a>\`:''}</td>
        <td>\${p.email?\`<a href="mailto:\${p.email}" class="text-cyan-400 text-xs hover:underline">\${p.email}</a>\`:''}</td>
        <td>\${p.website_url?\`<a href="\${p.website_url}" target="_blank" class="text-green-400 text-xs hover:underline">Visit</a>\`:''}</td>
        <td>\${p.whatsapp?\`<a href="https://wa.me/\${p.whatsapp}" target="_blank" class="text-green-500 text-xs hover:underline">\${p.whatsapp}</a>\`:''}</td>
        <td><span class="px-2 py-1 rounded text-xs font-bold" style="background:\${p.influence_score>60?'rgba(34,197,94,.2);color:#22C55E':p.influence_score>30?'rgba(234,179,8,.2);color:#EAB308':'rgba(107,114,128,.2);color:#9CA3AF'}">\${p.influence_score||0}</span></td>
      </tr>\`).join('')}
      </tbody></table></div>
    </div>\`:''}

    <!-- Quick-Browse Competitor Socials -->
    <div class="cd mb-5">
      <div class="ch"><h3>ğŸ” Quick-Browse Competitor Pages</h3><span class="bg bg-c">CLICK â†’ FIND COMMENTERS â†’ LOG BELOW</span></div>
      <div class="p-5">
        <p class="text-xs text-gray-500 mb-3">Open a competitor's Instagram/Facebook â†’ Scroll their latest posts â†’ See who's commenting â†’ Log their username below</p>
        <div class="grid grid-cols-2 gap-3">
          ${Object.entries(COMP_SOCIALS).filter(([k])=>!k.startsWith('_')).map(([name,s])=>`
            <div class="flex items-center gap-2 p-3 rounded-lg bg-gray-900/50 border border-gray-800">
              <span class="font-semibold text-sm flex-1">${name}</span>
              ${s.ig?`<a href="https://instagram.com/${s.ig}" target="_blank" class="btn bg2 bs" style="text-decoration:none">ğŸ“¸ IG</a>`:''}
              ${s.fb?`<a href="https://facebook.com/${s.fb}" target="_blank" class="btn bg2 bs" style="text-decoration:none">ğŸ“˜ FB</a>`:''}
              <a href="https://www.google.com/search?q=${encodeURIComponent(name+' LinkedIn')}" target="_blank" class="btn bg2 bs" style="text-decoration:none">ğŸ’¼ LI</a>
              <a href="https://www.google.com/search?q=${encodeURIComponent(name+' Twitter')}" target="_blank" class="btn bg2 bs" style="text-decoration:none">ğŸ¦ X</a>
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    <!-- Manual User Logger -->
    <div class="cd mb-5">
      <div class="ch"><h3>â• Log User from Any Platform</h3><span class="bg" style="background:rgba(255,77,45,.15);color:#FF4D2D">MANUAL SPY</span></div>
      <div class="p-5">
        <div class="grid grid-cols-5 gap-3 mb-3">
          <div><label class="text-xs text-gray-500 block mb-1">Username / Handle</label><input id="lu-username" class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm focus:outline-none focus:border-orange-500" placeholder="@username"></div>
          <div><label class="text-xs text-gray-500 block mb-1">Platform</label><select id="lu-platform" class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm"><option>Instagram</option><option>Facebook</option><option>LinkedIn</option><option>Twitter/X</option><option>YouTube</option></select></div>
          <div><label class="text-xs text-gray-500 block mb-1">Found on (Competitor)</label><select id="lu-competitor" class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm">${comps.map(c=>`<option>${c.name}</option>`).join('')}<option>_General</option></select></div>
          <div><label class="text-xs text-gray-500 block mb-1">Reaction Type</label><select id="lu-type" class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm"><option>comment</option><option>like</option><option>share</option><option>follow</option><option>mention</option></select></div>
          <div><label class="text-xs text-gray-500 block mb-1">Comment Text</label><input id="lu-comment" class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-sm focus:outline-none focus:border-orange-500" placeholder="What they said..."></div>
        </div>
        <button onclick="logUser()" class="btn bp">â• Log This User</button>
      </div>
    </div>

    <!-- All Users Table - ALL PLATFORMS -->
    <div class="cd">
      <div class="ch"><h3>ğŸ‘¥ All Tracked Users â€” Every Platform</h3><span class="bg bg-l">${engUsers.length} RECORDS</span></div>
      <div style="overflow-x:auto"><table class="tbl"><thead><tr><th>User</th><th>Platform</th><th>Profile</th><th>Competitor</th><th>Type</th><th>Comment/Action</th><th>Date</th></tr></thead><tbody>
      ${engUsers.slice(0,100).map(u=>`<tr>
        <td class="font-semibold text-sm">${u.display_name||u.username}</td>
        <td><span class="px-2 py-1 rounded text-xs font-semibold" style="background:${u.platform==='Instagram'?'rgba(225,48,108,.15);color:#E1306C':u.platform==='Facebook'?'rgba(24,119,242,.15);color:#1877F2':u.platform==='YouTube'?'rgba(255,0,0,.15);color:#FF0000':u.platform==='LinkedIn'?'rgba(10,102,194,.15);color:#0A66C2':u.platform==='Twitter/X'?'rgba(29,155,240,.15);color:#1DA1F0':'rgba(107,114,128,.15);color:#9CA3AF'}">${u.platform==='Instagram'?'ğŸ“¸':u.platform==='Facebook'?'ğŸ“˜':u.platform==='YouTube'?'â–¶ï¸':u.platform==='LinkedIn'?'ğŸ’¼':u.platform==='Twitter/X'?'ğŸ¦':'ğŸ”—'} ${u.platform}</span></td>
        <td>${u.profile_url?`<a href="${u.profile_url}" target="_blank" class="text-blue-400 text-xs hover:underline">Open Profile â†’</a>`:''}</td>
        <td class="text-xs" style="color:#FF4D2D">${u.competitor_name}</td>
        <td class="text-xs text-gray-500">${u.engagement_type||'comment'}</td>
        <td class="text-xs text-gray-400" style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${(u.content_text||'').replace(/<[^>]*>/g,'').substring(0,100)}</td>
        <td class="text-xs text-gray-600" style="font-family:monospace">${u.detected_at?timeAgo(new Date(u.detected_at)):''}</td>
      </tr>`).join('')}
      </tbody></table></div>
    </div>`;
  }

  else if(page==='insights'){
    t.textContent='ğŸ§  Market Insights';
    s.textContent='AI analysis from live competitor data';
    const topRated=comps.length?[...comps].sort((a,b)=>(b.google_rating||0)-(a.google_rating||0))[0]:null;
    const mostReviewed=comps.length?[...comps].sort((a,b)=>(b.google_reviews_count||0)-(a.google_reviews_count||0))[0]:null;
    const mostAds=comps.length?[...comps].sort((a,b)=>(b.active_ads_count||0)-(a.active_ads_count||0))[0]:null;

    el.innerHTML=`
    ${comps.length===0?'<div class="text-center py-20 text-gray-500">No data yet. Sync first.</div>':`
    <div class="grid grid-cols-3 gap-4 mb-5">
      <div class="cd p-5"><div class="text-xs text-yellow-400 font-semibold mb-2">â­ HIGHEST RATED</div><div class="text-lg font-bold">${topRated?.name||'â€”'}</div><div class="text-2xl font-bold text-yellow-400">${topRated?.google_rating||0}â˜…</div><div class="text-xs text-gray-500 mt-1">${(topRated?.google_reviews_count||0).toLocaleString()} reviews</div></div>
      <div class="cd p-5"><div class="text-xs text-blue-400 font-semibold mb-2">ğŸ“Š MOST REVIEWED</div><div class="text-lg font-bold">${mostReviewed?.name||'â€”'}</div><div class="text-2xl font-bold text-blue-400">${(mostReviewed?.google_reviews_count||0).toLocaleString()}</div><div class="text-xs text-gray-500 mt-1">${mostReviewed?.google_rating||0}â˜… rating</div></div>
      <div class="cd p-5"><div class="text-xs text-orange-400 font-semibold mb-2">ğŸ“¢ MOST ADS</div><div class="text-lg font-bold">${mostAds?.name||'â€”'}</div><div class="text-2xl font-bold text-orange-400">${mostAds?.active_ads_count||0} active</div><div class="text-xs text-gray-500 mt-1">Across FB + IG</div></div>
    </div>
    <div class="grid grid-cols-2 gap-5 mb-5">
      <div class="rounded-xl border border-orange-500/25 p-5" style="background:linear-gradient(135deg,rgba(255,77,45,.06),rgba(255,140,66,.03))">
        <div class="text-xs text-orange-400 font-semibold mb-2">ğŸ”¥ TOP OPPORTUNITY</div>
        <div class="text-lg font-bold mb-2">Launch Summer Mango Campaign</div>
        <div class="text-sm text-gray-400">Mango pickle demand peaks Febâ€“April. Multiple competitors already pushing seasonal combos. Move fast with early-bird pricing.</div>
      </div>
      <div class="rounded-xl border border-green-500/25 p-5" style="background:linear-gradient(135deg,rgba(34,197,94,.06),rgba(34,197,94,.03))">
        <div class="text-xs text-green-400 font-semibold mb-2">ğŸ’ YOUR EDGE</div>
        <div class="text-lg font-bold mb-2">"Homemade" Positioning is Open</div>
        <div class="text-sm text-gray-400">Competitor reviews say "mass-produced" and "factory taste". SeaSalt's handmade + cold-pressed angle is your biggest differentiator.</div>
      </div>
    </div>
    <div class="cd"><div class="ch"><h3>âš¡ Quick Actions â€” All Competitors</h3></div>
      <div class="p-5 space-y-3">${comps.slice(0,8).map(c=>{const act=aiActions(c)[0];return`
        <div class="flex items-start gap-3 pb-3 border-b border-gray-800/40">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center text-xs font-bold text-white flex-shrink-0" style="background:${c.color}">${c.code}</div>
          <div class="flex-1"><div class="text-sm font-semibold">${c.name}</div><div class="text-sm text-gray-400">${act.p} ${act.t}</div></div>
          <button onclick="drillTo('${c.name.replace(/'/g,"\\'")}');go('intel')" class="btn bg2 bs flex-shrink-0">Details â†’</button>
        </div>`;}).join('')}
      </div>
    </div>`}`;
  }
}

function exportCSV(){
  if(!comps.length)return alert('No data to export');
  const rows=[['Rank','Brand','URL','Rating','Reviews','Ads','Status','Last Synced']];
  comps.forEach((c,i)=>rows.push([i+1,c.name,c.url,c.google_rating,c.google_reviews_count,c.active_ads_count,c.status,c.last_synced]));
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([rows.map(r=>r.join(',')).join('\n')],{type:'text/csv'}));
  a.download='seasalt-intel-'+new Date().toISOString().slice(0,10)+'.csv';a.click();
}

// Init: Load data from Supabase on page load
loadData();
loadSocialData();
</script>
</body>
</html>
