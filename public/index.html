<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SeaSalt Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; }
        .sidebar { width: 250px; background: #1a1a2e; min-height: 100vh; position: fixed; left: 0; top: 0; z-index: 50; transition: transform 0.3s; }
        .sidebar.closed { transform: translateX(-250px); }
        .main { margin-left: 250px; padding: 24px; transition: margin-left 0.3s; }
        .main.expanded { margin-left: 0; }
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #a0a0b8; text-decoration: none; transition: all 0.2s; border-left: 3px solid transparent; }
        .sidebar-link:hover, .sidebar-link.active { color: #fff; background: rgba(255,255,255,0.08); border-left-color: #e67e22; }
        .card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .stat-card { text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 700; }
        .stat-label { font-size: 0.85rem; color: #666; margin-top: 4px; }
        .badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-green { background: #d4edda; color: #155724; }
        .badge-yellow { background: #fff3cd; color: #856404; }
        .badge-blue { background: #cce5ff; color: #004085; }
        .badge-red { background: #f8d7da; color: #721c24; }
        .badge-gray { background: #e2e3e5; color: #383d41; }
        .funnel { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 30px 0; flex-wrap: wrap; }
        .funnel-step { text-align: center; min-width: 90px; }
        .funnel-circle { width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; font-weight: 700; margin: 0 auto 8px; }
        .funnel-arrow { color: #ccc; font-size: 1.5rem; }
        .funnel-label { font-size: 0.8rem; color: #666; }
        .funnel-pct { font-size: 0.7rem; color: #999; margin-top: 2px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 12px; font-size: 0.8rem; color: #666; border-bottom: 2px solid #eee; text-transform: uppercase; }
        td { padding: 10px 12px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        tr:hover td { background: #f8f9fa; }
        .btn { padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; }
        .btn-primary { background: #e67e22; color: #fff; }
        .btn-primary:hover { background: #d35400; }
        .btn-sm { padding: 4px 10px; font-size: 0.75rem; }
        .page { display: none; }
        .page.active { display: block; }
        .login-overlay { position: fixed; inset: 0; background: linear-gradient(135deg, #1a1a2e, #16213e); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .login-box { background: #fff; padding: 40px; border-radius: 16px; width: 380px; max-width: 90vw; text-align: center; }
        .login-box input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; margin-bottom: 12px; font-size: 1rem; }
        .login-box input:focus { outline: none; border-color: #e67e22; }
        .bar-chart { display: flex; align-items: flex-end; gap: 6px; height: 120px; margin-top: 12px; }
        .bar { flex: 1; background: linear-gradient(to top, #e67e22, #f39c12); border-radius: 4px 4px 0 0; min-height: 4px; position: relative; transition: height 0.5s; }
        .bar-label { font-size: 0.65rem; color: #999; text-align: center; margin-top: 4px; }
        .product-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #f0f0f0; }
        .product-img-fallback { width: 50px; height: 50px; border-radius: 8px; background: linear-gradient(135deg, #e67e22, #f39c12); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 1.2rem; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 60; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-box { background: #fff; border-radius: 16px; padding: 24px; max-width: 600px; width: 90vw; max-height: 85vh; overflow-y: auto; }
        .refresh-btn { background: none; border: 2px solid #e67e22; color: #e67e22; padding: 6px 14px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .refresh-btn:hover { background: #e67e22; color: #fff; }
        .activity-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-blue { background: #3b82f6; }
        .dot-green { background: #10b981; }
        .dot-yellow { background: #f59e0b; }
        .dot-red { background: #ef4444; }
        .dot-purple { background: #8b5cf6; }
        .notification-badge { position: absolute; top: 8px; right: 15px; background: #ef4444; color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; font-weight: 700; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-250px); }
            .sidebar.open { transform: translateX(0); }
            .main { margin-left: 0; }
        }
    </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <div style="font-size:2.5rem;margin-bottom:12px;">ğŸ«™</div>
        <h2 style="font-size:1.5rem;font-weight:700;margin-bottom:4px;">SeaSalt Admin</h2>
        <p style="color:#888;margin-bottom:24px;font-size:0.9rem;">Enter credentials to continue</p>
        <input type="text" id="loginUser" placeholder="Username" autocomplete="off">
        <input type="password" id="loginPass" placeholder="Password">
        <button class="btn btn-primary" style="width:100%;padding:12px;" id="loginBtn">Sign In</button>
        <p id="loginError" style="color:#e74c3c;margin-top:12px;font-size:0.85rem;display:none;">Invalid credentials</p>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar" id="sidebar">
    <div style="padding:20px;border-bottom:1px solid rgba(255,255,255,0.1);">
        <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:40px;height:40px;background:#e67e22;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">ğŸ«™</div>
            <div>
                <div style="color:#fff;font-weight:700;font-size:1rem;">SeaSalt Admin</div>
                <div style="color:#888;font-size:0.75rem;">Analytics</div>
            </div>
        </div>
    </div>
    <nav style="margin-top:12px;">
        <a href="#" class="sidebar-link active" data-page="dashboard">ğŸ“Š Dashboard</a>
        <a href="#" class="sidebar-link" data-page="analytics">ğŸ“ˆ Analytics</a>
        <a href="#" class="sidebar-link" data-page="users">ğŸ‘¥ Users</a>
        <a href="#" class="sidebar-link" data-page="notifications" style="position:relative;">ğŸ”” Notifications <span class="notification-badge" id="notifBadge" style="display:none;">0</span></a>
        <a href="#" class="sidebar-link" data-page="products">ğŸ·ï¸ Products</a>
        <a href="#" class="sidebar-link" data-page="orders">ğŸ“¦ Orders</a>
        <a href="#" class="sidebar-link" data-page="shipping">ğŸšš Shipping</a>
        <a href="#" class="sidebar-link" data-page="settings">âš™ï¸ Settings</a>
    </nav>
    <div style="position:absolute;bottom:20px;left:20px;right:20px;">
        <a href="https://seasaltultimate.netlify.app" target="_blank" class="btn btn-primary" style="display:block;text-align:center;width:100%;">View Store â†’</a>
    </div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• MAIN CONTENT â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main" id="mainContent">
    <!-- Top Bar -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
        <div style="display:flex;align-items:center;gap:12px;">
            <button id="toggleSidebar" style="background:none;border:none;font-size:1.5rem;cursor:pointer;display:none;">â˜°</button>
            <h1 style="font-size:1.5rem;font-weight:700;" id="pageTitle">Dashboard</h1>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
            <button class="refresh-btn" id="refreshBtn">ğŸ”„ Refresh</button>
            <span style="font-size:0.8rem;color:#999;" id="lastUpdated"></span>
        </div>
    </div>

    <!-- â•â•â•â• DASHBOARD PAGE â•â•â•â•â•â• -->
    <div class="page active" id="page-dashboard">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px;">
            <div class="card stat-card"><div class="stat-value" style="color:#3b82f6;" id="statSessions">-</div><div class="stat-label">Sessions Today</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#10b981;" id="statPageViews">-</div><div class="stat-label">Page Views</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#f59e0b;" id="statOrders">-</div><div class="stat-label">Orders Today</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#e67e22;" id="statRevenue">-</div><div class="stat-label">Revenue Today</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
            <div class="card">
                <h3 style="font-weight:600;margin-bottom:8px;">ğŸ“ˆ Page Views (Last 7 Days)</h3>
                <div class="bar-chart" id="chartBars"></div>
                <div style="display:flex;gap:6px;margin-top:4px;" id="chartLabels"></div>
            </div>
            <div class="card">
                <h3 style="font-weight:600;margin-bottom:12px;">ğŸ”¥ Conversion Funnel</h3>
                <div class="funnel" id="dashFunnel"></div>
            </div>
        </div>
        <div class="card">
            <h3 style="font-weight:600;margin-bottom:12px;">ğŸ• Recent Activity</h3>
            <div id="recentActivity" style="max-height:300px;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â• ANALYTICS PAGE â•â•â•â•â•â• -->
    <div class="page" id="page-analytics">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:24px;">
            <div class="card stat-card"><div class="stat-value" style="color:#3b82f6;" id="anSessions">-</div><div class="stat-label">Total Sessions</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#10b981;" id="anPageViews">-</div><div class="stat-label">Total Page Views</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#8b5cf6;" id="anAvgTime">-</div><div class="stat-label">Avg Time on Page</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#ef4444;" id="anBounceRate">-</div><div class="stat-label">Bounce Rate</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#e67e22;" id="anConversion">-</div><div class="stat-label">Conversion Rate</div></div>
        </div>
        <div class="card" style="margin-bottom:24px;">
            <h3 style="font-weight:600;margin-bottom:12px;">ğŸ”„ Conversion Funnel</h3>
            <div class="funnel" id="analyticsFunnel"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
            <div class="card">
                <h3 style="font-weight:600;margin-bottom:12px;">ğŸ“± Device Breakdown</h3>
                <div id="deviceBreakdown"></div>
            </div>
            <div class="card">
                <h3 style="font-weight:600;margin-bottom:12px;">ğŸŒ Traffic Sources</h3>
                <div id="trafficSources"></div>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
            <div class="card">
                <h3 style="font-weight:600;margin-bottom:12px;">ğŸ“„ Top Pages</h3>
                <div id="topPages"></div>
            </div>
            <div class="card">
                <h3 style="font-weight:600;margin-bottom:12px;">ğŸ·ï¸ Top Products Viewed</h3>
                <div id="topProductsViewed"></div>
            </div>
        </div>
        <div class="card">
            <h3 style="font-weight:600;margin-bottom:12px;">ğŸ• Live Activity Feed</h3>
            <div id="activityFeed" style="max-height:400px;overflow-y:auto;"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â• USERS PAGE â•â•â•â•â•â• -->
    <div class="page" id="page-users">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px;">
            <div class="card stat-card"><div class="stat-value" style="color:#3b82f6;" id="usersTotalUsers">-</div><div class="stat-label">Total Users</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#10b981;" id="usersLoggedIn">-</div><div class="stat-label">Logged In Users</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#f59e0b;" id="usersGuests">-</div><div class="stat-label">Guest Sessions</div></div>
            <div class="card stat-card"><div class="stat-value" style="color:#8b5cf6;" id="usersActiveToday">-</div><div class="stat-label">Active Today</div></div>
        </div>
        <div class="card">
            <h3 style="font-weight:600;margin-bottom:12px;">ğŸ“± Registered Users (Phone Numbers)</h3>
            <table>
                <thead><tr><th>User</th><th>Country</th><th>Visits</th><th>Cart</th><th>Purchases</th><th>Wallet</th><th>Last Active</th><th>Action</th></tr></thead>
                <tbody id="usersTable"></tbody>
            </table>
        </div>
    </div>

    <!-- â•â•â•â•â•â• NOTIFICATIONS PAGE â•â•â•â•â•â• -->
    <div class="page" id="page-notifications">
        <div style="display:flex;gap:16px;margin-bottom:24px;">
            <div class="card" style="flex:1;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 style="font-weight:600;">ğŸ”” Admin Alerts</h3>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-sm" style="background:#fef3c7;" id="testNotifBtn">ğŸ§ª Test Alert</button>
                        <button class="btn btn-sm" style="background:#eee;" id="markAllReadBtn">âœ“ Mark All Read</button>
                    </div>
                </div>
                <div id="notificationsList" style="max-height:500px;overflow-y:auto;"></div>
            </div>
        </div>
        <div class="card" style="max-width:400px;">
            <h4 style="font-weight:600;margin-bottom:12px;">â„¹ï¸ How Alerts Work</h4>
            <ul style="font-size:0.9rem;color:#666;line-height:1.8;padding-left:20px;">
                <li>ğŸ”¥ <strong>High Activity</strong> â€” User visits 4+ times in 24 hours without buying</li>
                <li>ğŸ”„ <strong>Repeat Visitor</strong> â€” User returns multiple times</li>
                <li>Alerts popup automatically every 30 seconds</li>
                <li>Click on a user to send them wallet credit!</li>
            </ul>
        </div>
    </div>

    <!-- â•â•â•â•â•â• PRODUCTS PAGE â•â•â•â•â•â• -->
    <div class="page" id="page-products">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <p style="color:#666;" id="productCount">Loading...</p>
            <button class="btn btn-primary" id="addProductBtn">+ Add Product</button>
        </div>
        <div class="card">
            <table>
                <thead><tr><th>Image</th><th>Product</th><th>Category</th><th>Price</th><th>Status</th><th>Actions</th></tr></thead>
                <tbody id="productsTable"></tbody>
            </table>
        </div>
    </div>

    <!-- â•â•â•â•â•â• ORDERS PAGE â•â•â•â•â•â• -->
    <div class="page" id="page-orders">
        <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
            <button class="btn btn-sm" style="background:#eee;" data-order-filter="all">All</button>
            <button class="btn btn-sm" style="background:#fff3cd;" data-order-filter="pending">Pending</button>
            <button class="btn btn-sm" style="background:#cce5ff;" data-order-filter="confirmed">Confirmed</button>
            <button class="btn btn-sm" style="background:#d4edda;" data-order-filter="shipped">Shipped</button>
            <button class="btn btn-sm" style="background:#d4edda;" data-order-filter="delivered">Delivered</button>
        </div>
        <div class="card">
            <table>
                <thead><tr><th>Order ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                <tbody id="ordersTable"></tbody>
            </table>
        </div>
    </div>

    <!-- â•â•â•â•â•â• SHIPPING PAGE â•â•â•â•â•â• -->
    <div class="page" id="page-shipping">
        <div class="card" style="margin-bottom:24px;">
            <h3 style="font-weight:600;margin-bottom:12px;">ğŸ“¦ Pending Shipments</h3>
            <table>
                <thead><tr><th>Order</th><th>Customer</th><th>Address</th><th>Partner</th><th>Tracking</th><th>Action</th></tr></thead>
                <tbody id="shippingTable"></tbody>
            </table>
        </div>
    </div>

    <!-- â•â•â•â•â•â• SETTINGS PAGE â•â•â•â•â•â• -->
    <div class="page" id="page-settings">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div>
                <div class="card">
                    <h3 style="font-weight:600;margin-bottom:16px;">âš™ï¸ Store Settings</h3>
                    <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:4px;">Store Name</label>
                    <input type="text" id="settingStoreName" value="SeaSalt Pickles" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;margin-bottom:12px;">
                    <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:4px;">Default Currency</label>
                    <select id="settingCurrency" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;margin-bottom:16px;">
                        <option value="INR">â‚¹ INR (Indian Rupee)</option>
                        <option value="USD">$ USD (US Dollar)</option>
                        <option value="GBP">Â£ GBP (British Pound)</option>
                        <option value="AED">Ø¯.Ø¥ AED (UAE Dirham)</option>
                    </select>
                    <button class="btn btn-primary" id="saveSettingsBtn">Save Settings</button>
                </div>
                <div class="card" style="margin-top:16px;">
                    <h3 style="font-weight:600;margin-bottom:16px;">ğŸ” Change Password</h3>
                    <input type="password" id="newPassword" placeholder="New password" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;margin-bottom:12px;">
                    <button class="btn btn-primary" id="changePassBtn">Update Password</button>
                </div>
            </div>
            <div>
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h3 style="font-weight:600;">ğŸšš Delivery Charges</h3>
                        <button class="btn btn-sm btn-primary" id="addDeliveryChargeBtn">+ Add</button>
                    </div>
                    <table style="font-size:0.85rem;">
                        <thead><tr><th>Country</th><th>Region</th><th>Free Above</th><th>Flat Fee</th><th>Actions</th></tr></thead>
                        <tbody id="deliveryChargesTable"></tbody>
                    </table>
                </div>
                <div class="card" style="margin-top:16px;">
                    <h3 style="font-weight:600;margin-bottom:12px;">ğŸŒ Active Countries</h3>
                    <p style="font-size:0.85rem;color:#666;margin-bottom:12px;">Countries shown in customer sign-up</p>
                    <div id="countriesList" style="max-height:200px;overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• DELIVERY CHARGE MODAL â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="deliveryModal">
    <div class="modal-box" style="max-width:400px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="font-weight:700;" id="deliveryModalTitle">Add Delivery Charge</h3>
            <button style="background:none;border:none;font-size:1.5rem;cursor:pointer;" onclick="document.getElementById('deliveryModal').classList.remove('show')">&times;</button>
        </div>
        <input type="hidden" id="dc-id">
        <label style="font-size:0.8rem;font-weight:600;">Country</label>
        <select id="dc-country" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;margin-bottom:12px;"></select>
        <label style="font-size:0.8rem;font-weight:600;">Region (optional)</label>
        <input type="text" id="dc-region" placeholder="e.g., Telangana, California" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;margin-bottom:12px;">
        <label style="font-size:0.8rem;font-weight:600;">Free Delivery Above (â‚¹)</label>
        <input type="number" id="dc-minFree" value="500" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;margin-bottom:12px;">
        <label style="font-size:0.8rem;font-weight:600;">Flat Delivery Fee (â‚¹)</label>
        <input type="number" id="dc-flatFee" value="50" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;margin-bottom:12px;">
        <label style="font-size:0.8rem;font-weight:600;">Notes</label>
        <input type="text" id="dc-notes" placeholder="e.g., Local delivery" style="width:100%;padding:10px;border:2px solid #eee;border-radius:8px;margin-bottom:16px;">
        <button class="btn btn-primary" style="width:100%;" id="saveDeliveryChargeBtn">Save</button>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• PRODUCT MODAL â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="productModal">
    <div class="modal-box">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="font-weight:700;" id="productModalTitle">Add Product</h3>
            <button style="background:none;border:none;font-size:1.5rem;cursor:pointer;" id="closeProductModal">&times;</button>
        </div>
        <div id="productForm">
            <input type="hidden" id="pf-id">
            <label style="font-size:0.8rem;font-weight:600;">Name</label>
            <input type="text" id="pf-name" style="width:100%;padding:8px;border:2px solid #eee;border-radius:6px;margin-bottom:10px;">
            <label style="font-size:0.8rem;font-weight:600;">Description</label>
            <textarea id="pf-desc" rows="2" style="width:100%;padding:8px;border:2px solid #eee;border-radius:6px;margin-bottom:10px;"></textarea>
            <label style="font-size:0.8rem;font-weight:600;">Category</label>
            <select id="pf-category" style="width:100%;padding:8px;border:2px solid #eee;border-radius:6px;margin-bottom:10px;">
                <option value="veg">Veg Pickles</option>
                <option value="nonveg">Non-Veg Pickles</option>
                <option value="masala">Masala & Karam Podi</option>
                <option value="sweets">Sweets & Snacks</option>
                <option value="combos">Combos</option>
            </select>
            <label style="font-size:0.8rem;font-weight:600;">Image URL</label>
            <input type="text" id="pf-image" placeholder="https://..." style="width:100%;padding:8px;border:2px solid #eee;border-radius:6px;margin-bottom:10px;">
            <label style="font-size:0.8rem;font-weight:600;">Badge (optional)</label>
            <input type="text" id="pf-badge" placeholder="e.g. Bestseller, Premium" style="width:100%;padding:8px;border:2px solid #eee;border-radius:6px;margin-bottom:10px;">
            <label style="font-size:0.8rem;font-weight:600;">Variants (JSON)</label>
            <textarea id="pf-variants" rows="3" style="width:100%;padding:8px;border:2px solid #eee;border-radius:6px;margin-bottom:10px;font-family:monospace;font-size:0.85rem;">[{"weight":"250g","price":199},{"weight":"500g","price":349}]</textarea>
            <div style="display:flex;gap:8px;margin-bottom:10px;">
                <label><input type="checkbox" id="pf-active" checked> Active</label>
                <label><input type="checkbox" id="pf-featured"> Featured</label>
            </div>
            <button class="btn btn-primary" style="width:100%;" id="saveProductBtn">Save Product</button>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â• ORDER DETAIL MODAL â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="orderModal">
    <div class="modal-box" id="orderModalContent"></div>
</div>

<script>
(function() {
    'use strict';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUPABASE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const SUPA_URL = 'https://yosjbsncvghpscsrvxds.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlvc2pic25jdmdocHNjc3J2eGRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMjc3NTgsImV4cCI6MjA4NTgwMzc1OH0.PNEbeofoyT7KdkzepRfqg-zqyBiGAat5ElCMiyQ4UAs';

    const db = supabase.createClient(SUPA_URL, SUPA_KEY);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const ADMIN_USER = 'admin';
    let ADMIN_PASS = localStorage.getItem('seasalt_admin_pass') || 'seasalt2024';

    function checkAuth() {
        if (sessionStorage.getItem('seasalt_admin_auth') === 'true') {
            document.getElementById('loginOverlay').style.display = 'none';
            loadAllData();
        }
    }

    document.getElementById('loginBtn').addEventListener('click', function() {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value.trim();
        if (u === ADMIN_USER && p === ADMIN_PASS) {
            sessionStorage.setItem('seasalt_admin_auth', 'true');
            document.getElementById('loginOverlay').style.display = 'none';
            loadAllData();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    });

    document.getElementById('loginPass').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') document.getElementById('loginBtn').click();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NAVIGATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const pages = ['dashboard', 'analytics', 'users', 'notifications', 'products', 'orders', 'shipping', 'settings'];
    const pageNames = { dashboard: 'Dashboard', analytics: 'Analytics', users: 'Users', notifications: 'Notifications', products: 'Products', orders: 'Orders', shipping: 'Shipping', settings: 'Settings' };

    document.querySelectorAll('.sidebar-link').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            showPage(page);
        });
    });

    function showPage(page) {
        pages.forEach(function(p) {
            const el = document.getElementById('page-' + p);
            if (el) el.classList.toggle('active', p === page);
        });
        document.querySelectorAll('.sidebar-link').forEach(function(l) {
            l.classList.toggle('active', l.getAttribute('data-page') === page);
        });
        document.getElementById('pageTitle').textContent = pageNames[page] || page;
    }

    document.getElementById('refreshBtn').addEventListener('click', loadAllData);

    // Mobile sidebar toggle
    const toggleBtn = document.getElementById('toggleSidebar');
    if (window.innerWidth <= 768) toggleBtn.style.display = 'block';
    toggleBtn.addEventListener('click', function() {
        document.getElementById('sidebar').classList.toggle('open');
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA LOADING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadAllData() {
        document.getElementById('lastUpdated').textContent = 'Loading...';
        try {
            await Promise.all([
                loadDashboard(),
                loadAnalytics(),
                loadUsers(),
                loadNotifications(),
                loadProducts(),
                loadOrders()
            ]);
        } catch (err) {
            console.error('Load error:', err);
        }
        document.getElementById('lastUpdated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DASHBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadDashboard() {
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString();

        // Today's events
        const { data: todayEvents } = await db.from('analytics_events').select('*').gte('created_at', today + 'T00:00:00Z');
        const events = todayEvents || [];

        const sessions = new Set(events.map(function(e) { return e.session_id; })).size;
        const views = events.filter(function(e) { return e.event_type === 'page_view'; }).length;
        const purchases = events.filter(function(e) { return e.event_type === 'purchase'; });
        const revenue = purchases.reduce(function(sum, e) {
            try { var d = JSON.parse(e.data || '{}'); return sum + (d.total || 0); } catch(x) { return sum; }
        }, 0);

        document.getElementById('statSessions').textContent = sessions;
        document.getElementById('statPageViews').textContent = views;
        document.getElementById('statOrders').textContent = purchases.length;
        document.getElementById('statRevenue').textContent = 'â‚¹' + revenue.toLocaleString();

        // Last 7 days chart
        const { data: weekEvents } = await db.from('analytics_events').select('created_at').eq('event_type', 'page_view').gte('created_at', weekAgo);
        renderWeekChart(weekEvents || []);

        // Funnel
        renderFunnel('dashFunnel', events);

        // Recent activity
        renderRecentActivity(events.slice(-20).reverse());
    }

    function renderWeekChart(events) {
        var days = {};
        var labels = [];
        for (var i = 6; i >= 0; i--) {
            var d = new Date(Date.now() - i * 86400000);
            var key = d.toISOString().split('T')[0];
            var label = d.toLocaleDateString('en', { weekday: 'short' });
            days[key] = 0;
            labels.push({ key: key, label: label });
        }
        events.forEach(function(e) {
            var key = e.created_at.split('T')[0];
            if (days[key] !== undefined) days[key]++;
        });
        var maxVal = Math.max.apply(null, Object.values(days).concat([1]));
        var barsHtml = '';
        var labelsHtml = '';
        labels.forEach(function(l) {
            var h = Math.max(4, (days[l.key] / maxVal) * 100);
            barsHtml += '<div class="bar" style="height:' + h + '%" title="' + days[l.key] + ' views"></div>';
            labelsHtml += '<div class="bar-label" style="flex:1;">' + l.label + '</div>';
        });
        document.getElementById('chartBars').innerHTML = barsHtml;
        document.getElementById('chartLabels').innerHTML = labelsHtml;
    }

    function renderFunnel(containerId, events) {
        var views = events.filter(function(e) { return e.event_type === 'page_view'; }).length;
        var carts = events.filter(function(e) { return e.event_type === 'add_to_cart'; }).length;
        var checkouts = events.filter(function(e) { return e.event_type === 'checkout_start'; }).length;
        var purchases = events.filter(function(e) { return e.event_type === 'purchase'; }).length;

        var steps = [
            { label: 'Views', value: views, color: '#dbeafe' },
            { label: 'Cart', value: carts, color: '#fef3c7' },
            { label: 'Checkout', value: checkouts, color: '#ede9fe' },
            { label: 'Purchase', value: purchases, color: '#d1fae5' }
        ];

        var html = '';
        steps.forEach(function(s, i) {
            var pct = i > 0 && steps[i - 1].value > 0 ? Math.round((s.value / steps[i - 1].value) * 100) : '';
            html += '<div class="funnel-step">';
            html += '<div class="funnel-circle" style="background:' + s.color + ';">' + s.value + '</div>';
            html += '<div class="funnel-label">' + s.label + '</div>';
            if (pct !== '') html += '<div class="funnel-pct">' + pct + '%</div>';
            html += '</div>';
            if (i < steps.length - 1) html += '<div class="funnel-arrow">â†’</div>';
        });
        document.getElementById(containerId).innerHTML = html;
    }

    function renderRecentActivity(events) {
        var el = document.getElementById('recentActivity');
        if (!events.length) { el.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">No activity yet. Visit your store to generate data!</p>'; return; }
        var dotMap = { page_view: 'dot-blue', product_view: 'dot-purple', add_to_cart: 'dot-yellow', checkout_start: 'dot-yellow', purchase: 'dot-green', search: 'dot-blue' };
        var labelMap = { page_view: 'Viewed page', product_view: 'Viewed product', add_to_cart: 'Added to cart', checkout_start: 'Started checkout', purchase: 'Purchased', search: 'Searched', page_exit: 'Left page', spin_wheel: 'Spun wheel' };
        var html = '';
        events.forEach(function(e) {
            var time = new Date(e.created_at).toLocaleTimeString();
            var label = labelMap[e.event_type] || e.event_type;
            var detail = e.page || '';
            if (e.product_name) detail = e.product_name;
            try { var d = JSON.parse(e.data || '{}'); if (d.query) detail = '"' + d.query + '"'; } catch(x) {}
            var phoneDisplay = e.user_phone ? '<span style="background:#e8f5e9;color:#2e7d32;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-left:6px;">ğŸ“± ' + e.user_phone + '</span>' : '<span style="background:#f5f5f5;color:#999;padding:2px 6px;border-radius:4px;font-size:0.7rem;margin-left:6px;">Guest</span>';
            html += '<div style="padding:8px 0;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">';
            html += '<span class="activity-dot ' + (dotMap[e.event_type] || 'dot-gray') + '"></span>';
            html += '<span style="font-size:0.85rem;">' + label + (detail ? ' â€” <strong>' + detail + '</strong>' : '') + '</span>';
            html += phoneDisplay;
            html += '<span style="margin-left:auto;font-size:0.75rem;color:#999;">' + time + '</span>';
            html += '</div>';
        });
        el.innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ANALYTICS PAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadAnalytics() {
        var thirtyDaysAgo = new Date(Date.now() - 30 * 86400000).toISOString();
        var { data: events } = await db.from('analytics_events').select('*').gte('created_at', thirtyDaysAgo).order('created_at', { ascending: false }).limit(5000);
        events = events || [];

        var sessions = new Set(events.map(function(e) { return e.session_id; })).size;
        var pageViews = events.filter(function(e) { return e.event_type === 'page_view'; }).length;

        // Avg time on page (from page_exit events)
        var exitEvents = events.filter(function(e) { return e.event_type === 'page_exit'; });
        var avgTime = 0;
        if (exitEvents.length > 0) {
            var totalTime = exitEvents.reduce(function(s, e) { return s + (e.time_on_page || 0); }, 0);
            avgTime = Math.round(totalTime / exitEvents.length);
        }

        // Bounce rate (sessions with only 1 page_view)
        var sessionViews = {};
        events.filter(function(e) { return e.event_type === 'page_view'; }).forEach(function(e) {
            sessionViews[e.session_id] = (sessionViews[e.session_id] || 0) + 1;
        });
        var bounces = Object.values(sessionViews).filter(function(v) { return v === 1; }).length;
        var bounceRate = sessions > 0 ? Math.round((bounces / sessions) * 100) : 0;

        // Conversion rate
        var purchases = events.filter(function(e) { return e.event_type === 'purchase'; }).length;
        var convRate = sessions > 0 ? ((purchases / sessions) * 100).toFixed(1) : '0';

        document.getElementById('anSessions').textContent = sessions;
        document.getElementById('anPageViews').textContent = pageViews;
        document.getElementById('anAvgTime').textContent = avgTime + 's';
        document.getElementById('anBounceRate').textContent = bounceRate + '%';
        document.getElementById('anConversion').textContent = convRate + '%';

        // Funnel
        renderFunnel('analyticsFunnel', events);

        // Device breakdown
        var devices = {};
        events.forEach(function(e) {
            var d = e.device_type || 'unknown';
            devices[d] = (devices[d] || 0) + 1;
        });
        renderBreakdown('deviceBreakdown', devices, { mobile: '#3b82f6', desktop: '#10b981', tablet: '#f59e0b', unknown: '#ccc' });

        // Traffic sources
        var sources = {};
        events.filter(function(e) { return e.event_type === 'page_view'; }).forEach(function(e) {
            var r = e.referrer || 'direct';
            sources[r] = (sources[r] || 0) + 1;
        });
        renderBreakdown('trafficSources', sources, { direct: '#3b82f6', google: '#ea4335', facebook: '#1877f2', instagram: '#e4405f', whatsapp: '#25d366' });

        // Top pages
        var pageCounts = {};
        events.filter(function(e) { return e.event_type === 'page_view'; }).forEach(function(e) {
            var p = e.page || 'unknown';
            pageCounts[p] = (pageCounts[p] || 0) + 1;
        });
        renderTopList('topPages', pageCounts);

        // Top products
        var productCounts = {};
        events.filter(function(e) { return e.event_type === 'product_view' && e.product_name; }).forEach(function(e) {
            productCounts[e.product_name] = (productCounts[e.product_name] || 0) + 1;
        });
        renderTopList('topProductsViewed', productCounts);

        // Activity feed
        renderRecentActivity(events.slice(0, 50));
        document.getElementById('activityFeed').innerHTML = document.getElementById('recentActivity').innerHTML;
    }

    function renderBreakdown(containerId, data, colors) {
        var total = Object.values(data).reduce(function(a, b) { return a + b; }, 0);
        if (total === 0) { document.getElementById(containerId).innerHTML = '<p style="color:#999;">No data yet</p>'; return; }
        var sorted = Object.entries(data).sort(function(a, b) { return b[1] - a[1]; });
        var html = '';
        sorted.forEach(function(item) {
            var pct = Math.round((item[1] / total) * 100);
            var color = (colors && colors[item[0]]) || '#999';
            html += '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;">';
            html += '<div style="width:12px;height:12px;border-radius:3px;background:' + color + ';"></div>';
            html += '<span style="font-size:0.85rem;flex:1;">' + item[0] + '</span>';
            html += '<span style="font-size:0.85rem;font-weight:600;">' + item[1] + ' (' + pct + '%)</span>';
            html += '</div>';
        });
        document.getElementById(containerId).innerHTML = html;
    }

    function renderTopList(containerId, data) {
        var sorted = Object.entries(data).sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
        if (!sorted.length) { document.getElementById(containerId).innerHTML = '<p style="color:#999;">No data yet</p>'; return; }
        var maxVal = sorted[0][1];
        var html = '';
        sorted.forEach(function(item, i) {
            var pct = Math.round((item[1] / maxVal) * 100);
            html += '<div style="padding:6px 0;">';
            html += '<div style="display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:3px;">';
            html += '<span>' + (i + 1) + '. ' + item[0] + '</span><span style="font-weight:600;">' + item[1] + '</span></div>';
            html += '<div style="height:6px;background:#f0f0f0;border-radius:3px;"><div style="height:100%;width:' + pct + '%;background:#e67e22;border-radius:3px;"></div></div>';
            html += '</div>';
        });
        document.getElementById(containerId).innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // USERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadUsers() {
        var thirtyDaysAgo = new Date(Date.now() - 30 * 86400000).toISOString();
        var today = new Date().toISOString().split('T')[0];
        
        // Fetch from users table (has name, country, wallet)
        var { data: usersData } = await db.from('users').select('*').order('last_seen', { ascending: false });
        usersData = usersData || [];
        
        // Also fetch events for activity stats
        var { data: events } = await db.from('analytics_events').select('*').gte('created_at', thirtyDaysAgo).order('created_at', { ascending: false });
        events = events || [];

        // Calculate stats
        var allSessions = new Set(events.map(function(e) { return e.session_id; })).size;
        var loggedInUsers = usersData.length;
        var guestSessions = new Set(events.filter(function(e) { return !e.user_phone; }).map(function(e) { return e.session_id; })).size;
        
        var todayEvents = events.filter(function(e) { return e.created_at && e.created_at.startsWith(today); });
        var activeToday = new Set(todayEvents.map(function(e) { return e.user_phone || e.session_id; })).size;

        document.getElementById('usersTotalUsers').textContent = allSessions;
        document.getElementById('usersLoggedIn').textContent = loggedInUsers;
        document.getElementById('usersGuests').textContent = guestSessions;
        document.getElementById('usersActiveToday').textContent = activeToday;

        // Build activity map from events
        var activityMap = {};
        events.forEach(function(e) {
            if (!e.user_phone) return;
            if (!activityMap[e.user_phone]) {
                activityMap[e.user_phone] = { pageViews: 0, cartAdds: 0, purchases: 0 };
            }
            if (e.event_type === 'page_view') activityMap[e.user_phone].pageViews++;
            if (e.event_type === 'add_to_cart') activityMap[e.user_phone].cartAdds++;
            if (e.event_type === 'purchase') activityMap[e.user_phone].purchases++;
        });

        var html = '';
        if (usersData.length === 0) {
            html = '<tr><td colspan="8" style="text-align:center;color:#999;padding:40px;">No registered users yet. Users appear here after they sign up via the spin wheel.</td></tr>';
        } else {
            usersData.forEach(function(u) {
                var activity = activityMap[u.phone] || { pageViews: 0, cartAdds: 0, purchases: 0 };
                var lastActive = u.last_seen ? new Date(u.last_seen).toLocaleString() : '-';
                var walletBadge = u.wallet_balance > 0 ? '<span class="badge badge-green">â‚¹' + u.wallet_balance + '</span>' : 'â‚¹0';
                var countryFlag = getCountryFlag(u.selected_country);
                
                html += '<tr>';
                html += '<td>';
                html += '<div><strong style="color:#333;">' + (u.name || 'Unknown') + '</strong></div>';
                html += '<div style="font-size:0.8rem;color:#666;">ğŸ“± ' + u.phone + '</div>';
                html += '</td>';
                html += '<td>' + countryFlag + ' ' + (u.selected_country || u.country || '-') + '</td>';
                html += '<td>' + (u.total_visits || activity.pageViews || 0) + '</td>';
                html += '<td>' + activity.cartAdds + '</td>';
                html += '<td>' + (u.total_purchases || 0) + '</td>';
                html += '<td>' + walletBadge + '</td>';
                html += '<td style="font-size:0.8rem;">' + lastActive + '</td>';
                html += '<td><button class="btn btn-sm btn-green" onclick="openWalletModal(\'' + u.phone + '\', ' + (u.wallet_balance || 0) + ', \'' + (u.name || '') + '\')">ğŸ’°</button></td>';
                html += '</tr>';
            });
        }
        document.getElementById('usersTable').innerHTML = html;
    }

    function getCountryFlag(country) {
        var flags = {
            'India': 'ğŸ‡®ğŸ‡³', 'United States': 'ğŸ‡ºğŸ‡¸', 'United Kingdom': 'ğŸ‡¬ğŸ‡§',
            'United Arab Emirates': 'ğŸ‡¦ğŸ‡ª', 'Singapore': 'ğŸ‡¸ğŸ‡¬', 'Australia': 'ğŸ‡¦ğŸ‡º',
            'Canada': 'ğŸ‡¨ğŸ‡¦', 'Germany': 'ğŸ‡©ğŸ‡ª', 'France': 'ğŸ‡«ğŸ‡·', 'Saudi Arabia': 'ğŸ‡¸ğŸ‡¦',
            'Qatar': 'ğŸ‡¶ğŸ‡¦', 'Kuwait': 'ğŸ‡°ğŸ‡¼', 'Oman': 'ğŸ‡´ğŸ‡²', 'Malaysia': 'ğŸ‡²ğŸ‡¾', 'New Zealand': 'ğŸ‡³ğŸ‡¿'
        };
        return flags[country] || 'ğŸŒ';
    }

    window.openWalletModal = function(phone, balance, name) {
        showUserDetail(phone);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRODUCTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadProducts() {
        var { data: products, error } = await db.from('products').select('*').order('created_at', { ascending: false });
        if (error) { console.error('Products error:', error); return; }
        products = products || [];
        document.getElementById('productCount').textContent = products.length + ' product(s)';

        var html = '';
        products.forEach(function(p) {
            var variants = [];
            try { variants = typeof p.variants === 'string' ? JSON.parse(p.variants) : (p.variants || []); } catch(e) {}
            var price = variants.length > 0 ? 'â‚¹' + variants[0].price : '-';
            var img = p.image && p.image.startsWith('http') ? '<img src="' + p.image + '" class="product-img" onerror="this.outerHTML=\'<div class=product-img-fallback>ğŸ«™</div>\'">' : '<div class="product-img-fallback">ğŸ«™</div>';
            var statusBadge = p.is_active ? '<span class="badge badge-green">Active</span>' : '<span class="badge badge-red">Inactive</span>';
            html += '<tr>';
            html += '<td>' + img + '</td>';
            html += '<td><strong>' + (p.name || '') + '</strong><br><span style="font-size:0.75rem;color:#999;">' + (p.id || '') + '</span></td>';
            html += '<td>' + (p.category || '-') + '</td>';
            html += '<td>' + price + '</td>';
            html += '<td>' + statusBadge + '</td>';
            html += '<td><button class="btn btn-sm btn-primary edit-product-btn" data-id="' + p.id + '">âœï¸ Edit</button></td>';
            html += '</tr>';
        });
        document.getElementById('productsTable').innerHTML = html || '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px;">No products found</td></tr>';

        // Attach edit handlers
        document.querySelectorAll('.edit-product-btn').forEach(function(btn) {
            btn.addEventListener('click', function() { editProduct(this.getAttribute('data-id'), products); });
        });
    }

    // Add product
    document.getElementById('addProductBtn').addEventListener('click', function() {
        document.getElementById('productModalTitle').textContent = 'Add Product';
        document.getElementById('pf-id').value = '';
        document.getElementById('pf-name').value = '';
        document.getElementById('pf-desc').value = '';
        document.getElementById('pf-category').value = 'veg';
        document.getElementById('pf-image').value = '';
        document.getElementById('pf-badge').value = '';
        document.getElementById('pf-variants').value = '[{"weight":"250g","price":199},{"weight":"500g","price":349}]';
        document.getElementById('pf-active').checked = true;
        document.getElementById('pf-featured').checked = false;
        document.getElementById('productModal').classList.add('show');
    });

    function editProduct(id, products) {
        var p = products.find(function(x) { return x.id === id; });
        if (!p) return;
        document.getElementById('productModalTitle').textContent = 'Edit Product';
        document.getElementById('pf-id').value = p.id;
        document.getElementById('pf-name').value = p.name || '';
        document.getElementById('pf-desc').value = p.description || '';
        document.getElementById('pf-category').value = p.category || 'veg';
        document.getElementById('pf-image').value = p.image || '';
        document.getElementById('pf-badge').value = p.badge || '';
        var variants = typeof p.variants === 'string' ? p.variants : JSON.stringify(p.variants || []);
        document.getElementById('pf-variants').value = variants;
        document.getElementById('pf-active').checked = p.is_active !== false;
        document.getElementById('pf-featured').checked = p.is_featured === true;
        document.getElementById('productModal').classList.add('show');
    }

    document.getElementById('closeProductModal').addEventListener('click', function() {
        document.getElementById('productModal').classList.remove('show');
    });

    document.getElementById('saveProductBtn').addEventListener('click', async function() {
        var id = document.getElementById('pf-id').value;
        var data = {
            name: document.getElementById('pf-name').value.trim(),
            description: document.getElementById('pf-desc').value.trim(),
            category: document.getElementById('pf-category').value,
            image: document.getElementById('pf-image').value.trim(),
            badge: document.getElementById('pf-badge').value.trim() || null,
            variants: document.getElementById('pf-variants').value.trim(),
            is_active: document.getElementById('pf-active').checked,
            is_featured: document.getElementById('pf-featured').checked
        };
        // Parse variants
        try { data.variants = JSON.parse(data.variants); } catch(e) { alert('Invalid variants JSON'); return; }
        if (!data.name) { alert('Product name required'); return; }

        if (id) {
            // Update
            var { error } = await db.from('products').update(data).eq('id', id);
            if (error) { alert('Update failed: ' + error.message); return; }
        } else {
            // Insert
            data.id = data.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+$/, '');
            var { error } = await db.from('products').insert(data);
            if (error) { alert('Insert failed: ' + error.message); return; }
        }
        document.getElementById('productModal').classList.remove('show');
        loadProducts();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // NOTIFICATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadNotifications() {
        var { data: notifs } = await db.from('admin_notifications').select('*').order('created_at', { ascending: false }).limit(50);
        notifs = notifs || [];

        var unread = notifs.filter(function(n) { return !n.is_read; }).length;
        var badge = document.getElementById('notifBadge');
        if (unread > 0) {
            badge.textContent = unread;
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }

        var html = '';
        if (notifs.length === 0) {
            html = '<p style="color:#999;text-align:center;padding:40px;">No notifications yet. Alerts will appear here when users visit your store multiple times.</p>';
        } else {
            notifs.forEach(function(n) {
                var time = new Date(n.created_at).toLocaleString();
                var bgColor = n.is_read ? '#fff' : '#fef3c7';
                var icon = n.type === 'high_activity' ? 'ğŸ”¥' : n.type === 'repeat_visitor' ? 'ğŸ”„' : 'ğŸ””';
                html += '<div style="padding:12px;margin-bottom:8px;border-radius:8px;background:' + bgColor + ';border:1px solid #eee;">';
                html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">';
                html += '<div style="flex:1;"><span style="font-size:1.2rem;margin-right:8px;">' + icon + '</span><strong style="color:#333;">' + n.message + '</strong>';
                html += '<div style="font-size:0.8rem;color:#999;margin-top:4px;">' + time + '</div></div>';
                html += '</div>';
                if (n.user_phone) {
                    html += '<div style="margin-top:10px;display:flex;gap:8px;">';
                    html += '<button class="btn btn-sm btn-primary" onclick="showUserDetail(\'' + n.user_phone + '\')">ğŸ‘¤ View User</button>';
                    html += '<button class="btn btn-sm btn-green" onclick="openWalletModal(\'' + n.user_phone + '\', 0)">ğŸ’° Send Credit</button>';
                    if (!n.is_read) html += '<button class="btn btn-sm" style="background:#eee;" onclick="markNotifRead(' + n.id + ')">âœ“ Mark Read</button>';
                    html += '</div>';
                }
                html += '</div>';
            });
        }
        document.getElementById('notificationsList').innerHTML = html;
    }

    window.markNotifRead = async function(id) {
        await db.from('admin_notifications').update({ is_read: true }).eq('id', id);
        loadNotifications();
    };

    // Mark all read button
    document.getElementById('markAllReadBtn').addEventListener('click', async function() {
        await db.from('admin_notifications').update({ is_read: true }).eq('is_read', false);
        loadNotifications();
    });

    // Test notification button
    document.getElementById('testNotifBtn').addEventListener('click', function() {
        showNotificationPopup({
            id: 0,
            type: 'high_activity',
            user_phone: '+919876543210',
            message: 'ğŸ§ª TEST: User +919876543210 has visited 5 times in the last 24 hours without purchasing!',
            created_at: new Date().toISOString()
        });
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ORDERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function loadOrders() {
        var { data: orders, error } = await db.from('orders').select('*').order('created_at', { ascending: false });
        if (error) { console.error('Orders error:', error); }
        orders = orders || [];

        renderOrdersTable(orders);

        // Shipping pending
        var pending = orders.filter(function(o) { return o.status === 'confirmed' || o.status === 'processing'; });
        renderShippingTable(pending);

        // Filter buttons
        document.querySelectorAll('[data-order-filter]').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var filter = this.getAttribute('data-order-filter');
                var filtered = filter === 'all' ? orders : orders.filter(function(o) { return o.status === filter; });
                renderOrdersTable(filtered);
            });
        });
    }

    function renderOrdersTable(orders) {
        var html = '';
        orders.forEach(function(o) {
            var items = [];
            try { items = typeof o.items === 'string' ? JSON.parse(o.items) : (o.items || []); } catch(e) {}
            var itemsStr = items.map(function(i) { return i.name; }).join(', ').substring(0, 40) || '-';
            var statusClass = { pending: 'badge-yellow', confirmed: 'badge-blue', processing: 'badge-blue', shipped: 'badge-green', delivered: 'badge-green', cancelled: 'badge-red' };
            var date = o.created_at ? new Date(o.created_at).toLocaleDateString() : '-';
            html += '<tr>';
            html += '<td><strong>' + (o.id || '').toString().substring(0, 8) + '</strong></td>';
            html += '<td>' + (o.customer_name || o.phone || '-') + '</td>';
            html += '<td style="font-size:0.8rem;">' + itemsStr + '</td>';
            html += '<td>â‚¹' + (o.total || 0) + '</td>';
            html += '<td><span class="badge ' + (statusClass[o.status] || 'badge-gray') + '">' + (o.status || 'unknown') + '</span></td>';
            html += '<td style="font-size:0.8rem;">' + date + '</td>';
            html += '<td>';
            html += '<select class="order-status-select" data-order-id="' + o.id + '" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:0.8rem;">';
            ['pending','confirmed','processing','shipped','delivered','cancelled'].forEach(function(s) {
                html += '<option value="' + s + '"' + (o.status === s ? ' selected' : '') + '>' + s + '</option>';
            });
            html += '</select>';
            html += '</td></tr>';
        });
        document.getElementById('ordersTable').innerHTML = html || '<tr><td colspan="7" style="text-align:center;color:#999;padding:40px;">No orders yet</td></tr>';

        // Status change handlers
        document.querySelectorAll('.order-status-select').forEach(function(sel) {
            sel.addEventListener('change', async function() {
                var orderId = this.getAttribute('data-order-id');
                var newStatus = this.value;
                await db.from('orders').update({ status: newStatus }).eq('id', orderId);
                loadOrders();
            });
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SHIPPING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderShippingTable(orders) {
        var html = '';
        orders.forEach(function(o) {
            html += '<tr>';
            html += '<td>' + (o.id || '').toString().substring(0, 8) + '</td>';
            html += '<td>' + (o.customer_name || '-') + '</td>';
            html += '<td style="font-size:0.8rem;">' + (o.address || '-') + '</td>';
            html += '<td><select class="ship-partner" data-oid="' + o.id + '" style="padding:4px;border:1px solid #ddd;border-radius:4px;font-size:0.8rem;">';
            html += '<option value="">Select</option><option>Delhivery</option><option>DTDC</option><option>DHL</option><option>Other</option>';
            html += '</select></td>';
            html += '<td><input type="text" class="ship-tracking" data-oid="' + o.id + '" placeholder="Tracking #" style="padding:4px;border:1px solid #ddd;border-radius:4px;width:120px;font-size:0.8rem;"></td>';
            html += '<td><button class="btn btn-sm btn-primary ship-btn" data-oid="' + o.id + '">Ship</button></td>';
            html += '</tr>';
        });
        document.getElementById('shippingTable').innerHTML = html || '<tr><td colspan="6" style="text-align:center;color:#999;padding:20px;">No pending shipments</td></tr>';

        // Ship button handlers
        document.querySelectorAll('.ship-btn').forEach(function(btn) {
            btn.addEventListener('click', async function() {
                var oid = this.getAttribute('data-oid');
                var partner = document.querySelector('.ship-partner[data-oid="' + oid + '"]').value;
                var tracking = document.querySelector('.ship-tracking[data-oid="' + oid + '"]').value;
                if (!partner) { alert('Select a shipping partner'); return; }
                await db.from('orders').update({
                    status: 'shipped',
                    shipping_partner: partner,
                    tracking_id: tracking
                }).eq('id', oid);
                loadOrders();
            });
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SETTINGS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('saveSettingsBtn').addEventListener('click', function() {
        alert('Settings saved!');
    });

    document.getElementById('changePassBtn').addEventListener('click', function() {
        var newP = document.getElementById('newPassword').value.trim();
        if (newP.length < 4) { alert('Password too short'); return; }
        ADMIN_PASS = newP;
        localStorage.setItem('seasalt_admin_pass', newP);
        alert('Password updated!');
        document.getElementById('newPassword').value = '';
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REAL-TIME POPUP NOTIFICATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let lastNotifCheck = Date.now();

    async function checkNewNotifications() {
        try {
            var { data: notifs } = await db.from('admin_notifications')
                .select('*')
                .eq('is_read', false)
                .order('created_at', { ascending: false })
                .limit(10);
            
            notifs = notifs || [];
            
            // Update badge
            var badge = document.getElementById('notifBadge');
            if (notifs.length > 0) {
                badge.textContent = notifs.length;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }

            // Check for NEW notifications (created after last check)
            var newNotifs = notifs.filter(function(n) {
                return new Date(n.created_at).getTime() > lastNotifCheck;
            });

            // Show popup for each new notification
            newNotifs.forEach(function(n) {
                showNotificationPopup(n);
            });

            lastNotifCheck = Date.now();
        } catch (err) {
            console.warn('Notification check failed:', err);
        }
    }

    function showNotificationPopup(notif) {
        // Play sound
        playNotifSound();

        // Create popup
        var popup = document.createElement('div');
        popup.style.cssText = 'position:fixed;top:20px;right:20px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.25);padding:16px 20px;z-index:9999;max-width:380px;animation:notifSlideIn 0.4s ease;border-left:5px solid #ef4444;';
        
        var icon = notif.type === 'high_activity' ? 'ğŸ”¥' : notif.type === 'repeat_visitor' ? 'ğŸ”„' : 'ğŸ””';
        var title = notif.type === 'high_activity' ? 'High Activity Alert!' : 'New Notification';
        var bgColor = notif.type === 'high_activity' ? '#fef2f2' : '#fffbeb';
        popup.style.background = bgColor;
        
        popup.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;">' +
            '<div style="flex:1;">' +
            '<div style="font-weight:700;font-size:1.1rem;margin-bottom:6px;color:#dc2626;">' + icon + ' ' + title + '</div>' +
            '<div style="font-size:0.9rem;color:#333;margin-bottom:10px;line-height:1.4;">' + notif.message + '</div>' +
            '<div style="display:flex;gap:8px;">' +
            (notif.user_phone ? '<button class="btn btn-sm btn-primary" onclick="showUserDetail(\'' + notif.user_phone + '\');this.closest(\'.notif-popup\').remove();">ğŸ‘¤ View User</button> ' : '') +
            '<button class="btn btn-sm btn-green" onclick="markNotifRead(' + notif.id + ');this.closest(\'.notif-popup\').remove();">âœ“ Got it</button>' +
            '</div>' +
            '</div>' +
            '<button onclick="this.closest(\'.notif-popup\').remove()" style="background:none;border:none;font-size:1.3rem;cursor:pointer;color:#999;padding:0;line-height:1;">&times;</button>' +
            '</div>';
        
        popup.className = 'notif-popup';
        document.body.appendChild(popup);

        // Auto-remove after 20 seconds
        setTimeout(function() {
            if (popup.parentElement) {
                popup.style.animation = 'notifSlideOut 0.4s ease forwards';
                setTimeout(function() { if (popup.parentElement) popup.remove(); }, 400);
            }
        }, 20000);
    }

    function playNotifSound() {
        try {
            var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            // Play two-tone alert
            [800, 1000].forEach(function(freq, i) {
                setTimeout(function() {
                    var osc = audioCtx.createOscillator();
                    var gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.value = 0.2;
                    osc.start();
                    setTimeout(function() { osc.stop(); }, 150);
                }, i * 200);
            });
        } catch (e) {}
    }

    // Add CSS animations
    var notifStyles = document.createElement('style');
    notifStyles.textContent = '@keyframes notifSlideIn{from{transform:translateX(120%);opacity:0;}to{transform:translateX(0);opacity:1;}}@keyframes notifSlideOut{from{transform:translateX(0);opacity:1;}to{transform:translateX(120%);opacity:0;}}';
    document.head.appendChild(notifStyles);

    // Check for new notifications every 30 seconds
    setInterval(checkNewNotifications, 30000);
    
    // Also check immediately after login
    setTimeout(checkNewNotifications, 2000);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DELIVERY CHARGES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let deliveryCharges = [];
    let countriesList = [];

    async function loadDeliveryCharges() {
        // Load delivery charges
        var { data: charges } = await db.from('delivery_charges').select('*').order('country');
        deliveryCharges = charges || [];
        
        // Load countries
        var { data: countries } = await db.from('countries').select('*').order('sort_order');
        countriesList = countries || [];
        
        renderDeliveryChargesTable();
        renderCountriesList();
        populateCountryDropdown();
    }

    function renderDeliveryChargesTable() {
        var html = '';
        if (deliveryCharges.length === 0) {
            html = '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px;">No delivery charges configured</td></tr>';
        } else {
            deliveryCharges.forEach(function(dc) {
                html += '<tr>';
                html += '<td><strong>' + dc.country + '</strong></td>';
                html += '<td>' + (dc.region || 'All') + '</td>';
                html += '<td>â‚¹' + (dc.min_order_free || 0) + '</td>';
                html += '<td>â‚¹' + (dc.flat_charge || 0) + '</td>';
                html += '<td>';
                html += '<button class="btn btn-sm" style="background:#eee;margin-right:4px;" onclick="editDeliveryCharge(' + dc.id + ')">âœï¸</button>';
                html += '<button class="btn btn-sm" style="background:#fee;color:#c00;" onclick="deleteDeliveryCharge(' + dc.id + ')">ğŸ—‘ï¸</button>';
                html += '</td>';
                html += '</tr>';
            });
        }
        document.getElementById('deliveryChargesTable').innerHTML = html;
    }

    function renderCountriesList() {
        var html = '';
        countriesList.forEach(function(c) {
            var checked = c.is_active ? 'checked' : '';
            html += '<div style="display:flex;align-items:center;gap:8px;padding:4px 0;">';
            html += '<input type="checkbox" ' + checked + ' onchange="toggleCountry(\'' + c.code + '\', this.checked)">';
            html += '<span style="font-size:0.9rem;">' + c.name + ' (' + c.currency_symbol + ')</span>';
            html += '</div>';
        });
        document.getElementById('countriesList').innerHTML = html || '<p style="color:#999;">No countries configured</p>';
    }

    function populateCountryDropdown() {
        var select = document.getElementById('dc-country');
        select.innerHTML = '<option value="">Select country</option>';
        countriesList.forEach(function(c) {
            select.innerHTML += '<option value="' + c.name + '">' + c.name + '</option>';
        });
    }

    window.toggleCountry = async function(code, isActive) {
        await db.from('countries').update({ is_active: isActive }).eq('code', code);
        loadDeliveryCharges();
    };

    document.getElementById('addDeliveryChargeBtn').addEventListener('click', function() {
        document.getElementById('deliveryModalTitle').textContent = 'Add Delivery Charge';
        document.getElementById('dc-id').value = '';
        document.getElementById('dc-country').value = '';
        document.getElementById('dc-region').value = '';
        document.getElementById('dc-minFree').value = '500';
        document.getElementById('dc-flatFee').value = '50';
        document.getElementById('dc-notes').value = '';
        document.getElementById('deliveryModal').classList.add('show');
    });

    window.editDeliveryCharge = function(id) {
        var dc = deliveryCharges.find(function(d) { return d.id === id; });
        if (!dc) return;
        document.getElementById('deliveryModalTitle').textContent = 'Edit Delivery Charge';
        document.getElementById('dc-id').value = dc.id;
        document.getElementById('dc-country').value = dc.country;
        document.getElementById('dc-region').value = dc.region || '';
        document.getElementById('dc-minFree').value = dc.min_order_free || 0;
        document.getElementById('dc-flatFee').value = dc.flat_charge || 0;
        document.getElementById('dc-notes').value = dc.notes || '';
        document.getElementById('deliveryModal').classList.add('show');
    };

    window.deleteDeliveryCharge = async function(id) {
        if (!confirm('Delete this delivery charge?')) return;
        await db.from('delivery_charges').delete().eq('id', id);
        loadDeliveryCharges();
    };

    document.getElementById('saveDeliveryChargeBtn').addEventListener('click', async function() {
        var id = document.getElementById('dc-id').value;
        var data = {
            country: document.getElementById('dc-country').value,
            region: document.getElementById('dc-region').value || null,
            min_order_free: parseFloat(document.getElementById('dc-minFree').value) || 0,
            flat_charge: parseFloat(document.getElementById('dc-flatFee').value) || 0,
            notes: document.getElementById('dc-notes').value || null
        };
        
        if (!data.country) { alert('Please select a country'); return; }
        
        if (id) {
            await db.from('delivery_charges').update(data).eq('id', id);
        } else {
            await db.from('delivery_charges').insert(data);
        }
        
        document.getElementById('deliveryModal').classList.remove('show');
        loadDeliveryCharges();
    });

    document.getElementById('deliveryModal').addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('show');
    });

    // Load delivery charges on init
    setTimeout(loadDeliveryCharges, 1000);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    checkAuth();

})();
</script>
</body>
</html>
